---
title: Gestione delle chiavi in ASP.NET Core
author: rick-anderson
description: Ulteriori dettagli sull'implementazione della gestione delle chiavi di ASP.NET Core Data Protection API.
ms.author: riande
ms.date: 10/14/2016
uid: security/data-protection/implementation/key-management
ms.openlocfilehash: be8597a2522c3145056dee709210de065e8cb593
ms.sourcegitcommit: a1afd04758e663d7062a5bfa8a0d4dca38f42afc
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 06/20/2018
ms.locfileid: "36276630"
---
# <a name="key-management-in-aspnet-core"></a><span data-ttu-id="eeeef-103">Gestione delle chiavi in ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="eeeef-103">Key management in ASP.NET Core</span></span>

<a name="data-protection-implementation-key-management"></a>

<span data-ttu-id="eeeef-104">Il sistema di protezione dati gestisce automaticamente la durata delle chiavi master utilizzata per proteggere e annullare la protezione di payload.</span><span class="sxs-lookup"><span data-stu-id="eeeef-104">The data protection system automatically manages the lifetime of master keys used to protect and unprotect payloads.</span></span> <span data-ttu-id="eeeef-105">Ogni chiave può essere presente in una delle quattro fasi:</span><span class="sxs-lookup"><span data-stu-id="eeeef-105">Each key can exist in one of four stages:</span></span>

* <span data-ttu-id="eeeef-106">Create - la chiave esiste nell'anello chiave, ma non è ancora stata attivata.</span><span class="sxs-lookup"><span data-stu-id="eeeef-106">Created - the key exists in the key ring but has not yet been activated.</span></span> <span data-ttu-id="eeeef-107">La chiave non deve essere usata per le nuove operazioni di proteggere fino a quando non è trascorso tempo sufficiente che la chiave abbia avuto la possibilità di propagare a tutti i computer che utilizzano la gestione delle chiavi.</span><span class="sxs-lookup"><span data-stu-id="eeeef-107">The key shouldn't be used for new Protect operations until sufficient time has elapsed that the key has had a chance to propagate to all machines that are consuming this key ring.</span></span>

* <span data-ttu-id="eeeef-108">Attivo: la chiave esiste nell'anello chiave e deve essere utilizzato per tutte le nuove operazioni di protezione.</span><span class="sxs-lookup"><span data-stu-id="eeeef-108">Active - the key exists in the key ring and should be used for all new Protect operations.</span></span>

* <span data-ttu-id="eeeef-109">La chiave scaduta - è stata eseguita la relativa durata naturale e non deve più essere usata per le nuove operazioni di protezione.</span><span class="sxs-lookup"><span data-stu-id="eeeef-109">Expired - the key has run its natural lifetime and should no longer be used for new Protect operations.</span></span>

* <span data-ttu-id="eeeef-110">Revocato - la chiave viene compromessa e non deve essere utilizzata per nuove operazioni di protezione.</span><span class="sxs-lookup"><span data-stu-id="eeeef-110">Revoked - the key is compromised and must not be used for new Protect operations.</span></span>

<span data-ttu-id="eeeef-111">Chiavi create, attive e scadute possono tutti essere utilizzate per rimuovere la protezione di payload in ingresso.</span><span class="sxs-lookup"><span data-stu-id="eeeef-111">Created, active, and expired keys may all be used to unprotect incoming payloads.</span></span> <span data-ttu-id="eeeef-112">Revocati chiavi per impostazione predefinita, non possono essere utilizzate per rimuovere la protezione di payload, ma lo sviluppatore di applicazioni può [eseguire l'override di questo comportamento](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) se necessario.</span><span class="sxs-lookup"><span data-stu-id="eeeef-112">Revoked keys by default may not be used to unprotect payloads, but the application developer can [override this behavior](xref:security/data-protection/consumer-apis/dangerous-unprotect#data-protection-consumer-apis-dangerous-unprotect) if necessary.</span></span>

>[!WARNING]
> <span data-ttu-id="eeeef-113">Lo sviluppatore potrebbe essere tentato di eliminare una chiave dall'anello chiave (ad esempio, eliminando il file corrispondente dal file system).</span><span class="sxs-lookup"><span data-stu-id="eeeef-113">The developer might be tempted to delete a key from the key ring (e.g., by deleting the corresponding file from the file system).</span></span> <span data-ttu-id="eeeef-114">A questo punto, tutti i dati protetti dalla chiave è definitivamente decifrabili e vi sono sostituzioni emergenza come con chiavi revocate.</span><span class="sxs-lookup"><span data-stu-id="eeeef-114">At that point, all data protected by the key is permanently undecipherable, and there's no emergency override like there's with revoked keys.</span></span> <span data-ttu-id="eeeef-115">Eliminazione di una chiave è realmente distruttivo comportamento e di conseguenza il sistema di protezione dati non espone alcuna API di prima classe per eseguire questa operazione.</span><span class="sxs-lookup"><span data-stu-id="eeeef-115">Deleting a key is truly destructive behavior, and consequently the data protection system exposes no first-class API for performing this operation.</span></span>

## <a name="default-key-selection"></a><span data-ttu-id="eeeef-116">Selezione chiave predefinita</span><span class="sxs-lookup"><span data-stu-id="eeeef-116">Default key selection</span></span>

<span data-ttu-id="eeeef-117">Quando il sistema di protezione dati legge la gestione delle chiavi dal repository sottostante, verrà effettuato un tentativo di individuare una chiave "default" dalla chiave di sequenza.</span><span class="sxs-lookup"><span data-stu-id="eeeef-117">When the data protection system reads the key ring from the backing repository, it will attempt to locate a "default" key from the key ring.</span></span> <span data-ttu-id="eeeef-118">La chiave predefinita viene utilizzata per nuove operazioni di protezione.</span><span class="sxs-lookup"><span data-stu-id="eeeef-118">The default key is used for new Protect operations.</span></span>

<span data-ttu-id="eeeef-119">L'euristica generale è che il sistema di protezione dati viene scelta la chiave con la data più recente di attivazione come chiave predefinita.</span><span class="sxs-lookup"><span data-stu-id="eeeef-119">The general heuristic is that the data protection system chooses the key with the most recent activation date as the default key.</span></span> <span data-ttu-id="eeeef-120">(È disponibile una tecnica per indurre piccoli per consentire il server a server clock inclinazione). Se la chiave è scaduta o revocata, generazione di chiavi e se l'applicazione non ha disabilitato automatica, quindi verrà generata una nuova chiave con l'attivazione immediata per il [in sequenza e scadenza della chiave](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) criteri riportato di seguito.</span><span class="sxs-lookup"><span data-stu-id="eeeef-120">(There's a small fudge factor to allow for server-to-server clock skew.) If the key is expired or revoked, and if the application has not disabled automatic key generation, then a new key will be generated with immediate activation per the [key expiration and rolling](xref:security/data-protection/implementation/key-management#data-protection-implementation-key-management-expiration) policy below.</span></span>

<span data-ttu-id="eeeef-121">Il motivo per il sistema di protezione di dati genera una nuova chiave immediatamente, anziché eseguire il fallback su un'altra chiave è che la nuova generazione di chiavi deve essere considerata come una scadenza implicita di tutte le chiavi che sono stati attivati prima la nuova chiave.</span><span class="sxs-lookup"><span data-stu-id="eeeef-121">The reason the data protection system generates a new key immediately rather than falling back to a different key is that new key generation should be treated as an implicit expiration of all keys that were activated prior to the new key.</span></span> <span data-ttu-id="eeeef-122">L'idea generale è che le nuove chiavi potrebbero essere state configurate con algoritmi diversi o meccanismi di crittografia a riposo rispetto a quelle precedenti e il sistema deve utilizzare la configurazione corrente su cui eseguire il fallback.</span><span class="sxs-lookup"><span data-stu-id="eeeef-122">The general idea is that new keys may have been configured with different algorithms or encryption-at-rest mechanisms than old keys, and the system should prefer the current configuration over falling back.</span></span>

<span data-ttu-id="eeeef-123">Si verifica un'eccezione.</span><span class="sxs-lookup"><span data-stu-id="eeeef-123">There's an exception.</span></span> <span data-ttu-id="eeeef-124">Se lo sviluppatore di applicazioni ha [disabilitata la generazione automatica delle chiave](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), quindi il sistema di protezione dati è necessario scegliere un elemento come chiave predefinita.</span><span class="sxs-lookup"><span data-stu-id="eeeef-124">If the application developer has [disabled automatic key generation](xref:security/data-protection/configuration/overview#disableautomatickeygeneration), then the data protection system must choose something as the default key.</span></span> <span data-ttu-id="eeeef-125">In questo scenario di fallback, il sistema sceglierà la chiave non è stato revocato con la data più recente di attivazione, usando preferibilmente delle chiavi che hanno avuto tempo per propagare ad altri computer nel cluster.</span><span class="sxs-lookup"><span data-stu-id="eeeef-125">In this fallback scenario, the system will choose the non-revoked key with the most recent activation date, with preference given to keys that have had time to propagate to other machines in the cluster.</span></span> <span data-ttu-id="eeeef-126">Il sistema di fallback può finire la scelta di una chiave predefinita scaduta di conseguenza.</span><span class="sxs-lookup"><span data-stu-id="eeeef-126">The fallback system may end up choosing an expired default key as a result.</span></span> <span data-ttu-id="eeeef-127">Il sistema di fallback non sceglierà mai una chiave revocata come chiave predefinita e se la gestione delle chiavi è vuoto o se ogni chiave è stato revocato il sistema verrà generato un errore al momento dell'inizializzazione.</span><span class="sxs-lookup"><span data-stu-id="eeeef-127">The fallback system will never choose a revoked key as the default key, and if the key ring is empty or every key has been revoked then the system will produce an error upon initialization.</span></span>

<a name="data-protection-implementation-key-management-expiration"></a>

## <a name="key-expiration-and-rolling"></a><span data-ttu-id="eeeef-128">Scadenza della chiave e in sequenza</span><span class="sxs-lookup"><span data-stu-id="eeeef-128">Key expiration and rolling</span></span>

<span data-ttu-id="eeeef-129">Quando viene creata una chiave, assegnato automaticamente una data di attivazione di {now + 2 giorni} e una data di scadenza di {now + 90 giorni}.</span><span class="sxs-lookup"><span data-stu-id="eeeef-129">When a key is created, it's automatically given an activation date of { now + 2 days } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="eeeef-130">Il ritardo di 2 giorni prima dell'attivazione offre il tempo chiave per propagare nel sistema.</span><span class="sxs-lookup"><span data-stu-id="eeeef-130">The 2-day delay before activation gives the key time to propagate through the system.</span></span> <span data-ttu-id="eeeef-131">Che consente di altre applicazioni verso l'archivio di backup osservare la chiave al loro successivo periodo di aggiornamento automatico, pertanto consente di massimizzare le probabilità che la chiave dell'anello fa diventano attive sono state propagate a tutte le applicazioni che potrebbe essere necessario usarlo.</span><span class="sxs-lookup"><span data-stu-id="eeeef-131">That is, it allows other applications pointing at the backing store to observe the key at their next auto-refresh period, thus maximizing the chances that when the key ring does become active it has propagated to all applications that might need to use it.</span></span>

<span data-ttu-id="eeeef-132">Se la chiave predefinita scadrà entro 2 giorni e la gestione delle chiavi non dispone già di una chiave che sarà attiva dopo la scadenza della chiave predefinita, il sistema di protezione dati mantiene automaticamente una nuova chiave per la gestione delle chiavi.</span><span class="sxs-lookup"><span data-stu-id="eeeef-132">If the default key will expire within 2 days and if the key ring doesn't already have a key that will be active upon expiration of the default key, then the data protection system will automatically persist a new key to the key ring.</span></span> <span data-ttu-id="eeeef-133">La nuova chiave ha una data di attivazione di {data di scadenza della chiave predefinita} e una data di scadenza di {now + 90 giorni}.</span><span class="sxs-lookup"><span data-stu-id="eeeef-133">This new key has an activation date of { default key's expiration date } and an expiration date of { now + 90 days }.</span></span> <span data-ttu-id="eeeef-134">Questo consente al sistema di eseguire automaticamente il rollback delle chiavi a intervalli regolari senza interruzione del servizio.</span><span class="sxs-lookup"><span data-stu-id="eeeef-134">This allows the system to automatically roll keys on a regular basis with no interruption of service.</span></span>

<span data-ttu-id="eeeef-135">Potrebbe verificarsi casi in cui verrà creata una chiave con attivazione immediato.</span><span class="sxs-lookup"><span data-stu-id="eeeef-135">There might be circumstances where a key will be created with immediate activation.</span></span> <span data-ttu-id="eeeef-136">Un esempio potrebbe essere quando l'applicazione non è stata eseguita per un periodo di tempo e tutte le chiavi dell'anello di chiave sono scadute.</span><span class="sxs-lookup"><span data-stu-id="eeeef-136">One example would be when the application hasn't run for a time and all keys in the key ring are expired.</span></span> <span data-ttu-id="eeeef-137">In questo caso, la chiave ha una data di attivazione di {ora} senza il ritardo di attivazione di 2 giorni normali.</span><span class="sxs-lookup"><span data-stu-id="eeeef-137">When this happens, the key is given an activation date of { now } without the normal 2-day activation delay.</span></span>

<span data-ttu-id="eeeef-138">Durata della chiave predefinita è 90 giorni, anche se questa opzione è configurabile come nell'esempio seguente.</span><span class="sxs-lookup"><span data-stu-id="eeeef-138">The default key lifetime is 90 days, though this is configurable as in the following example.</span></span>

```csharp
services.AddDataProtection()
       // use 14-day lifetime instead of 90-day lifetime
       .SetDefaultKeyLifetime(TimeSpan.FromDays(14));
```

<span data-ttu-id="eeeef-139">Un amministratore può inoltre modificare il valore predefinito a livello di sistema, anche se una chiamata esplicita a `SetDefaultKeyLifetime` eseguirà l'override di tutti i criteri a livello di sistema.</span><span class="sxs-lookup"><span data-stu-id="eeeef-139">An administrator can also change the default system-wide, though an explicit call to `SetDefaultKeyLifetime` will override any system-wide policy.</span></span> <span data-ttu-id="eeeef-140">Durata della chiave predefinita non può essere inferiore a 7 giorni.</span><span class="sxs-lookup"><span data-stu-id="eeeef-140">The default key lifetime cannot be shorter than 7 days.</span></span>

## <a name="automatic-key-ring-refresh"></a><span data-ttu-id="eeeef-141">Aggiornamento automatico delle chiavi</span><span class="sxs-lookup"><span data-stu-id="eeeef-141">Automatic key ring refresh</span></span>

<span data-ttu-id="eeeef-142">Quando si inizializza il sistema di protezione dati, legge la gestione delle chiavi dal repository sottostante e lo memorizza nella cache in memoria.</span><span class="sxs-lookup"><span data-stu-id="eeeef-142">When the data protection system initializes, it reads the key ring from the underlying repository and caches it in memory.</span></span> <span data-ttu-id="eeeef-143">Questa cache consente operazioni di protezione e Unprotect continuare senza raggiungere l'archivio di backup.</span><span class="sxs-lookup"><span data-stu-id="eeeef-143">This cache allows Protect and Unprotect operations to proceed without hitting the backing store.</span></span> <span data-ttu-id="eeeef-144">Il sistema controlla automaticamente l'archivio di backup per le modifiche circa ogni 24 ore o quando scade la chiave predefinita corrente, verifica per primo.</span><span class="sxs-lookup"><span data-stu-id="eeeef-144">The system will automatically check the backing store for changes approximately every 24 hours or when the current default key expires, whichever comes first.</span></span>

>[!WARNING]
> <span data-ttu-id="eeeef-145">Gli sviluppatori devono raramente (se applicabile) è necessario utilizzare direttamente le API di gestione principali.</span><span class="sxs-lookup"><span data-stu-id="eeeef-145">Developers should very rarely (if ever) need to use the key management APIs directly.</span></span> <span data-ttu-id="eeeef-146">Il sistema di protezione dati eseguirà gestione automatica delle chiavi, come descritto in precedenza.</span><span class="sxs-lookup"><span data-stu-id="eeeef-146">The data protection system will perform automatic key management as described above.</span></span>

<span data-ttu-id="eeeef-147">Il sistema di protezione dati espone un'interfaccia `IKeyManager` che può essere utilizzato per controllare e apportare modifiche per la gestione delle chiavi.</span><span class="sxs-lookup"><span data-stu-id="eeeef-147">The data protection system exposes an interface `IKeyManager` that can be used to inspect and make changes to the key ring.</span></span> <span data-ttu-id="eeeef-148">Il sistema DI cui l'istanza di `IDataProtectionProvider` può anche fornire un'istanza di `IKeyManager` per il consumo.</span><span class="sxs-lookup"><span data-stu-id="eeeef-148">The DI system that provided the instance of `IDataProtectionProvider` can also provide an instance of `IKeyManager` for your consumption.</span></span> <span data-ttu-id="eeeef-149">In alternativa, è possibile effettuare il pull di `IKeyManager` direttamente dal `IServiceProvider` come nell'esempio seguente.</span><span class="sxs-lookup"><span data-stu-id="eeeef-149">Alternatively, you can pull the `IKeyManager` straight from the `IServiceProvider` as in the example below.</span></span>

<span data-ttu-id="eeeef-150">Qualsiasi operazione che modifica la gestione delle chiavi (creazione di una nuova chiave in modo esplicito o l'esecuzione di una revoca) invalida la cache in memoria.</span><span class="sxs-lookup"><span data-stu-id="eeeef-150">Any operation which modifies the key ring (creating a new key explicitly or performing a revocation) will invalidate the in-memory cache.</span></span> <span data-ttu-id="eeeef-151">La chiamata successiva a `Protect` o `Unprotect` il sistema di protezione dati esegua la rilettura di gestione delle chiavi e la ricreazione della cache.</span><span class="sxs-lookup"><span data-stu-id="eeeef-151">The next call to `Protect` or `Unprotect` will cause the data protection system to reread the key ring and recreate the cache.</span></span>

<span data-ttu-id="eeeef-152">Nell'esempio seguente viene illustrato l'utilizzo di `IKeyManager` interfaccia per esaminare e manipolare l'anello chiave, tra cui revocare le chiavi esistenti e generare manualmente una nuova chiave.</span><span class="sxs-lookup"><span data-stu-id="eeeef-152">The sample below demonstrates using the `IKeyManager` interface to inspect and manipulate the key ring, including revoking existing keys and generating a new key manually.</span></span>

[!code-csharp[](key-management/samples/key-management.cs)]

## <a name="key-storage"></a><span data-ttu-id="eeeef-153">Archiviazione delle chiavi</span><span class="sxs-lookup"><span data-stu-id="eeeef-153">Key storage</span></span>

<span data-ttu-id="eeeef-154">Il sistema di protezione dati è un approccio euristico in base al quale si tenta di dedurre un percorso di archiviazione chiavi appropriata e la crittografia a meccanismo rest automaticamente.</span><span class="sxs-lookup"><span data-stu-id="eeeef-154">The data protection system has a heuristic whereby it tries to deduce an appropriate key storage location and encryption at rest mechanism automatically.</span></span> <span data-ttu-id="eeeef-155">È anche configurabile dallo sviluppatore di app.</span><span class="sxs-lookup"><span data-stu-id="eeeef-155">This is also configurable by the app developer.</span></span> <span data-ttu-id="eeeef-156">I documenti seguenti illustrano le implementazioni nella casella di questi meccanismi:</span><span class="sxs-lookup"><span data-stu-id="eeeef-156">The following documents discuss the in-box implementations of these mechanisms:</span></span>

* [<span data-ttu-id="eeeef-157">Nella casella provider di archiviazione chiavi</span><span class="sxs-lookup"><span data-stu-id="eeeef-157">In-box key storage providers</span></span>](xref:security/data-protection/implementation/key-storage-providers#data-protection-implementation-key-storage-providers)

* [<span data-ttu-id="eeeef-158">Crittografia della chiave nella casella provider di rest</span><span class="sxs-lookup"><span data-stu-id="eeeef-158">In-box key encryption at rest providers</span></span>](xref:security/data-protection/implementation/key-encryption-at-rest#data-protection-implementation-key-encryption-at-rest-providers)
