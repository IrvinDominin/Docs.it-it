---
title: Gestione della chiave di protezione dati e la durata in ASP.NET Core
author: rick-anderson
description: Informazioni sulla gestione delle chiavi protezione dei dati e la durata in ASP.NET Core.
ms.author: riande
ms.date: 10/14/2016
uid: security/data-protection/configuration/default-settings
ms.openlocfilehash: 54259b1e2f37cdbbd551038e80f2b0fa1d77f196
ms.sourcegitcommit: a1afd04758e663d7062a5bfa8a0d4dca38f42afc
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 06/20/2018
ms.locfileid: "36277812"
---
# <a name="data-protection-key-management-and-lifetime-in-aspnet-core"></a><span data-ttu-id="e86e2-103">Gestione della chiave di protezione dati e la durata in ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="e86e2-103">Data Protection key management and lifetime in ASP.NET Core</span></span>

<span data-ttu-id="e86e2-104">Di [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="e86e2-104">By [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

## <a name="key-management"></a><span data-ttu-id="e86e2-105">Gestione delle chiavi</span><span class="sxs-lookup"><span data-stu-id="e86e2-105">Key management</span></span>

<span data-ttu-id="e86e2-106">L'applicazione tenta di rilevare l'ambiente operativo e gestire chiavi configurazione nel proprio.</span><span class="sxs-lookup"><span data-stu-id="e86e2-106">The app attempts to detect its operational environment and handle key configuration on its own.</span></span>

1. <span data-ttu-id="e86e2-107">Se l'applicazione è ospitata in [App Azure](https://azure.microsoft.com/services/app-service/), le chiavi vengono rese persistenti il *%HOME%\ASP.NET\DataProtection-Keys* cartella.</span><span class="sxs-lookup"><span data-stu-id="e86e2-107">If the app is hosted in [Azure Apps](https://azure.microsoft.com/services/app-service/), keys are persisted to the *%HOME%\ASP.NET\DataProtection-Keys* folder.</span></span> <span data-ttu-id="e86e2-108">La cartella è associata all'archiviazione di rete e sincronizzata in tutti i computer che ospitano l'app.</span><span class="sxs-lookup"><span data-stu-id="e86e2-108">This folder is backed by network storage and is synchronized across all machines hosting the app.</span></span>
   * <span data-ttu-id="e86e2-109">Le chiavi non vengono protette quando sono inattive.</span><span class="sxs-lookup"><span data-stu-id="e86e2-109">Keys aren't protected at rest.</span></span>
   * <span data-ttu-id="e86e2-110">Il *DataProtection chiavi* cartella fornisce la gestione delle chiavi a tutte le istanze di un'app in uno slot di distribuzione singolo.</span><span class="sxs-lookup"><span data-stu-id="e86e2-110">The *DataProtection-Keys* folder supplies the key ring to all instances of an app in a single deployment slot.</span></span>
   * <span data-ttu-id="e86e2-111">Gli slot di distribuzione separati, ad esempio gli slot di gestione temporanea e di produzione, non condividono un KeyRing.</span><span class="sxs-lookup"><span data-stu-id="e86e2-111">Separate deployment slots, such as Staging and Production, don't share a key ring.</span></span> <span data-ttu-id="e86e2-112">Durante lo scambio tra gli slot di distribuzione, ad esempio lo scambio di gestione temporanea nell'ambiente di produzione o utilizzando A / B test, qualsiasi app utilizzando la protezione dei dati non saranno in grado di decrittografare i dati archiviati tramite la gestione delle chiavi all'interno di slot precedente.</span><span class="sxs-lookup"><span data-stu-id="e86e2-112">When you swap between deployment slots, for example swapping Staging to Production or using A/B testing, any app using Data Protection won't be able to decrypt stored data using the key ring inside the previous slot.</span></span> <span data-ttu-id="e86e2-113">Questo porta agli utenti viene registrati da un'app che utilizza l'autenticazione dei cookie ASP.NET Core standard, in quanto utilizza la protezione dei dati per proteggere i propri cookie.</span><span class="sxs-lookup"><span data-stu-id="e86e2-113">This leads to users being logged out of an app that uses the standard ASP.NET Core cookie authentication, as it uses Data Protection to protect its cookies.</span></span> <span data-ttu-id="e86e2-114">Se si desiderano anelli chiave indipendente di slot, usare un provider di chiavi esterne, ad esempio l'archiviazione di Blob di Azure, insieme di credenziali chiave di Azure, un archivio SQL, oppure cache Redis.</span><span class="sxs-lookup"><span data-stu-id="e86e2-114">If you desire slot-independent key rings, use an external key ring provider, such as Azure Blob Storage, Azure Key Vault, a SQL store, or Redis cache.</span></span>

1. <span data-ttu-id="e86e2-115">Se il profilo utente è disponibile, le chiavi vengono rese persistenti il *%LOCALAPPDATA%\ASP.NET\DataProtection-Keys* cartella.</span><span class="sxs-lookup"><span data-stu-id="e86e2-115">If the user profile is available, keys are persisted to the *%LOCALAPPDATA%\ASP.NET\DataProtection-Keys* folder.</span></span> <span data-ttu-id="e86e2-116">Se il sistema operativo è Windows, le chiavi vengono crittografate a riposo usando la DPAPI.</span><span class="sxs-lookup"><span data-stu-id="e86e2-116">If the operating system is Windows, the keys are encrypted at rest using DPAPI.</span></span>

1. <span data-ttu-id="e86e2-117">Se l'applicazione è ospitata in IIS, le chiavi vengono mantenute nel Registro di sistema HKLM in una chiave del Registro di sistema speciale solo per l'account del processo di lavoro.</span><span class="sxs-lookup"><span data-stu-id="e86e2-117">If the app is hosted in IIS, keys are persisted to the HKLM registry in a special registry key that's ACLed only to the worker process account.</span></span> <span data-ttu-id="e86e2-118">Le chiavi vengono crittografate a riposo tramite la DPAPI.</span><span class="sxs-lookup"><span data-stu-id="e86e2-118">Keys are encrypted at rest using DPAPI.</span></span>

1. <span data-ttu-id="e86e2-119">Se nessuna di queste condizioni corrispondono, le chiavi non sono persistenti all'esterno del processo corrente.</span><span class="sxs-lookup"><span data-stu-id="e86e2-119">If none of these conditions match, keys aren't persisted outside of the current process.</span></span> <span data-ttu-id="e86e2-120">Quando il processo viene arrestato, tutti generati le chiavi vengono perse.</span><span class="sxs-lookup"><span data-stu-id="e86e2-120">When the process shuts down, all generated keys are lost.</span></span>

<span data-ttu-id="e86e2-121">Lo sviluppatore è sempre il controllo completo e può eseguire l'override di come e dove sono memorizzate chiavi.</span><span class="sxs-lookup"><span data-stu-id="e86e2-121">The developer is always in full control and can override how and where keys are stored.</span></span> <span data-ttu-id="e86e2-122">Le prime tre opzioni sopra devono fornire buoni valori predefiniti per la maggior parte delle applicazioni allo stesso modo in ASP.NET  **\<machineKey >** routine la generazione automatica funzionavano in passato.</span><span class="sxs-lookup"><span data-stu-id="e86e2-122">The first three options above should provide good defaults for most apps similar to how the ASP.NET **\<machineKey>** auto-generation routines worked in the past.</span></span> <span data-ttu-id="e86e2-123">L'opzione di fallback, finale è l'unico scenario che richiede allo sviluppatore di specificare [configurazione](xref:security/data-protection/configuration/overview) iniziale se desiderano persistenza chiave, ma questo fallback si verifica solo in rare situazioni.</span><span class="sxs-lookup"><span data-stu-id="e86e2-123">The final, fallback option is the only scenario that requires the developer to specify [configuration](xref:security/data-protection/configuration/overview) upfront if they want key persistence, but this fallback only occurs in rare situations.</span></span>

<span data-ttu-id="e86e2-124">Durante l'hosting in un contenitore Docker, chiavi devono essere mantenute in una cartella che è un volume di Docker (un volume condiviso o un volume montato host che viene mantenuto oltre la durata del contenitore) o in un provider esterno, ad esempio [insieme credenziali chiavi Azure](https://azure.microsoft.com/services/key-vault/) o [Redis](https://redis.io/).</span><span class="sxs-lookup"><span data-stu-id="e86e2-124">When hosting in a Docker container, keys should be persisted in a folder that's a Docker volume (a shared volume or a host-mounted volume that persists beyond the container's lifetime) or in an external provider, such as [Azure Key Vault](https://azure.microsoft.com/services/key-vault/) or [Redis](https://redis.io/).</span></span> <span data-ttu-id="e86e2-125">Un provider esterno è utile in scenari web farm anche se le app non è possibile accedere a un volume di rete condivisa (vedere [PersistKeysToFileSystem](xref:security/data-protection/configuration/overview#persistkeystofilesystem) per altre informazioni).</span><span class="sxs-lookup"><span data-stu-id="e86e2-125">An external provider is also useful in web farm scenarios if apps can't access a shared network volume (see [PersistKeysToFileSystem](xref:security/data-protection/configuration/overview#persistkeystofilesystem) for more information).</span></span>

> [!WARNING]
> <span data-ttu-id="e86e2-126">Se lo sviluppatore sostituisce le regole descritte in precedenza e indica al sistema di protezione dei dati in un repository di chiave specifico, la crittografia automatica delle chiavi di resto è disabilitata.</span><span class="sxs-lookup"><span data-stu-id="e86e2-126">If the developer overrides the rules outlined above and points the Data Protection system at a specific key repository, automatic encryption of keys at rest is disabled.</span></span> <span data-ttu-id="e86e2-127">Nella protezione dei dati può essere riabilitata tramite [configurazione](xref:security/data-protection/configuration/overview).</span><span class="sxs-lookup"><span data-stu-id="e86e2-127">At-rest protection can be re-enabled via [configuration](xref:security/data-protection/configuration/overview).</span></span>

## <a name="key-lifetime"></a><span data-ttu-id="e86e2-128">Durata della chiave</span><span class="sxs-lookup"><span data-stu-id="e86e2-128">Key lifetime</span></span>

<span data-ttu-id="e86e2-129">Per impostazione predefinita, le chiavi hanno una durata di 90 giorni.</span><span class="sxs-lookup"><span data-stu-id="e86e2-129">Keys have a 90-day lifetime by default.</span></span> <span data-ttu-id="e86e2-130">Quando una chiave scade, l'applicazione genera una nuova chiave automaticamente e imposta la nuova chiave come chiave attiva.</span><span class="sxs-lookup"><span data-stu-id="e86e2-130">When a key expires, the app automatically generates a new key and sets the new key as the active key.</span></span> <span data-ttu-id="e86e2-131">Fino a quando le chiavi ritirate restano nel sistema, l'app può decrittografare i dati protetti con essi.</span><span class="sxs-lookup"><span data-stu-id="e86e2-131">As long as retired keys remain on the system, your app can decrypt any data protected with them.</span></span> <span data-ttu-id="e86e2-132">Vedere [gestione delle chiavi](xref:security/data-protection/implementation/key-management#key-expiration-and-rolling) per ulteriori informazioni.</span><span class="sxs-lookup"><span data-stu-id="e86e2-132">See [key management](xref:security/data-protection/implementation/key-management#key-expiration-and-rolling) for more information.</span></span>

## <a name="default-algorithms"></a><span data-ttu-id="e86e2-133">Algoritmi predefiniti</span><span class="sxs-lookup"><span data-stu-id="e86e2-133">Default algorithms</span></span>

<span data-ttu-id="e86e2-134">L'algoritmo di protezione dati di payload predefinito utilizzato è AES-256-CBC la riservatezza e HMACSHA256 l'autenticità.</span><span class="sxs-lookup"><span data-stu-id="e86e2-134">The default payload protection algorithm used is AES-256-CBC for confidentiality and HMACSHA256 for authenticity.</span></span> <span data-ttu-id="e86e2-135">Una chiave master di 512 bit, cambiata ogni 90 giorni, viene usata per derivare le due chiavi secondario utilizzate per questi algoritmi in base al payload.</span><span class="sxs-lookup"><span data-stu-id="e86e2-135">A 512-bit master key, changed every 90 days, is used to derive the two sub-keys used for these algorithms on a per-payload basis.</span></span> <span data-ttu-id="e86e2-136">Vedere [sottochiave derivazione](xref:security/data-protection/implementation/subkeyderivation#additional-authenticated-data-and-subkey-derivation) per ulteriori informazioni.</span><span class="sxs-lookup"><span data-stu-id="e86e2-136">See [subkey derivation](xref:security/data-protection/implementation/subkeyderivation#additional-authenticated-data-and-subkey-derivation) for more information.</span></span>

## <a name="see-also"></a><span data-ttu-id="e86e2-137">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="e86e2-137">See also</span></span>

* [<span data-ttu-id="e86e2-138">Estendibilità della gestione delle chiavi</span><span class="sxs-lookup"><span data-stu-id="e86e2-138">Key management extensibility</span></span>](xref:security/data-protection/extensibility/key-management)
