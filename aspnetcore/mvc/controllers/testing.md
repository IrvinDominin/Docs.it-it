---
title: Test della logica dei controller in ASP.NET Core
author: ardalis
description: Informazioni sul test della logica dei controller in ASP.NET Core con Moq e xUnit.
ms.author: riande
ms.date: 10/14/2016
uid: mvc/controllers/testing
ms.openlocfilehash: fc5f10b4d5947a6af114bf00f8b1d955b083a44d
ms.sourcegitcommit: a1afd04758e663d7062a5bfa8a0d4dca38f42afc
ms.translationtype: HT
ms.contentlocale: it-IT
ms.lasthandoff: 06/20/2018
ms.locfileid: "36273923"
---
# <a name="test-controller-logic-in-aspnet-core"></a><span data-ttu-id="220a7-103">Test della logica dei controller in ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="220a7-103">Test controller logic in ASP.NET Core</span></span>

<span data-ttu-id="220a7-104">Di [Steve Smith](https://ardalis.com/)</span><span class="sxs-lookup"><span data-stu-id="220a7-104">By [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="220a7-105">I controller nelle app ASP.NET MVC devono avere dimensioni ridotte ed essere incentrati sugli aspetti dell'interfaccia utente.</span><span class="sxs-lookup"><span data-stu-id="220a7-105">Controllers in ASP.NET MVC apps should be small and focused on user-interface concerns.</span></span> <span data-ttu-id="220a7-106">Il test e la gestione risultano più complessi con controller di grandi dimensioni che gestiscono aspetti non associati all'interfaccia utente.</span><span class="sxs-lookup"><span data-stu-id="220a7-106">Large controllers that deal with non-UI concerns are more difficult to test and maintain.</span></span>

[<span data-ttu-id="220a7-107">Visualizzare o scaricare un esempio da GitHub</span><span class="sxs-lookup"><span data-stu-id="220a7-107">View or download sample from GitHub</span></span>](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample)

## <a name="testing-controllers"></a><span data-ttu-id="220a7-108">Test dei controller</span><span class="sxs-lookup"><span data-stu-id="220a7-108">Testing controllers</span></span>

<span data-ttu-id="220a7-109">I controller sono un componente essenziale di qualsiasi applicazione ASP.NET Core MVC.</span><span class="sxs-lookup"><span data-stu-id="220a7-109">Controllers are a central part of any ASP.NET Core MVC application.</span></span> <span data-ttu-id="220a7-110">Di conseguenza è importante verificare che funzionino correttamente nell'app.</span><span class="sxs-lookup"><span data-stu-id="220a7-110">As such, you should have confidence they behave as intended for your app.</span></span> <span data-ttu-id="220a7-111">I test automatizzati eseguono questa verifica e rilevano gli errori dei controller prima che questi raggiungano la fase di produzione.</span><span class="sxs-lookup"><span data-stu-id="220a7-111">Automated tests can provide you with this confidence and can detect errors before they reach production.</span></span> <span data-ttu-id="220a7-112">È importante evitare di includere responsabilità non necessarie nei controller e verificare che i test riguardino esclusivamente le responsabilità dei controller.</span><span class="sxs-lookup"><span data-stu-id="220a7-112">It's important to avoid placing unnecessary responsibilities within your controllers and ensure your tests focus only on controller responsibilities.</span></span>

<span data-ttu-id="220a7-113">La logica del controller deve essere minima e non incentrata su logica di business o aspetti dell'infrastruttura (ad esempio l'accesso ai dati).</span><span class="sxs-lookup"><span data-stu-id="220a7-113">Controller logic should be minimal and not be focused on business logic or infrastructure concerns (for example, data access).</span></span> <span data-ttu-id="220a7-114">Il test deve riguardare la logica del controller e non il framework.</span><span class="sxs-lookup"><span data-stu-id="220a7-114">Test controller logic, not the framework.</span></span> <span data-ttu-id="220a7-115">Eseguire test del *comportamento* del controller con input validi e non validi.</span><span class="sxs-lookup"><span data-stu-id="220a7-115">Test how the controller *behaves* based on valid or invalid inputs.</span></span> <span data-ttu-id="220a7-116">Eseguire il test delle risposte del controller in base ai risultati dell'operazione di business effettuata dal controller.</span><span class="sxs-lookup"><span data-stu-id="220a7-116">Test controller responses based on the result of the business operation it performs.</span></span>

<span data-ttu-id="220a7-117">Responsabilità tipiche del controller:</span><span class="sxs-lookup"><span data-stu-id="220a7-117">Typical controller responsibilities:</span></span>

* <span data-ttu-id="220a7-118">Verificare `ModelState.IsValid`.</span><span class="sxs-lookup"><span data-stu-id="220a7-118">Verify `ModelState.IsValid`.</span></span>
* <span data-ttu-id="220a7-119">Restituire un errore se `ModelState` non è valido.</span><span class="sxs-lookup"><span data-stu-id="220a7-119">Return an error response if `ModelState` is invalid.</span></span>
* <span data-ttu-id="220a7-120">Recuperare un'entità di business dalla persistenza.</span><span class="sxs-lookup"><span data-stu-id="220a7-120">Retrieve a business entity from persistence.</span></span>
* <span data-ttu-id="220a7-121">Eseguire un'azione nell'entità di business.</span><span class="sxs-lookup"><span data-stu-id="220a7-121">Perform an action on the business entity.</span></span>
* <span data-ttu-id="220a7-122">Salvare l'entità di business nella persistenza.</span><span class="sxs-lookup"><span data-stu-id="220a7-122">Save the business entity to persistence.</span></span>
* <span data-ttu-id="220a7-123">Restituire un risultato `IActionResult` appropriato.</span><span class="sxs-lookup"><span data-stu-id="220a7-123">Return an appropriate `IActionResult`.</span></span>

## <a name="unit-testing"></a><span data-ttu-id="220a7-124">Testing unità</span><span class="sxs-lookup"><span data-stu-id="220a7-124">Unit testing</span></span>

<span data-ttu-id="220a7-125">Lo [unit test](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) prevede l'esecuzione di test su una parte di un'app isolandola dall'infrastruttura e dalle dipendenze.</span><span class="sxs-lookup"><span data-stu-id="220a7-125">[Unit testing](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) involves testing a part of an app in isolation from its infrastructure and dependencies.</span></span> <span data-ttu-id="220a7-126">Quando si sottopone a unit test la logica del controller, si verifica solo il contenuto di una singola azione e non il comportamento delle relative dipendenze o del framework.</span><span class="sxs-lookup"><span data-stu-id="220a7-126">When unit testing controller logic, only the contents of a single action is tested, not the behavior of its dependencies or of the framework itself.</span></span> <span data-ttu-id="220a7-127">Quando si sottopongono a unit test le azioni del controller, è importante concentrarsi esclusivamente sul funzionamento del controller.</span><span class="sxs-lookup"><span data-stu-id="220a7-127">As you unit test your controller actions, make sure you focus only on its behavior.</span></span> <span data-ttu-id="220a7-128">Uno unit test del controller non prende in esame elementi come [filtri](filters.md), [routing](../../fundamentals/routing.md) o [associazione di modelli](../models/model-binding.md).</span><span class="sxs-lookup"><span data-stu-id="220a7-128">A controller unit test avoids things like [filters](filters.md), [routing](../../fundamentals/routing.md), or [model binding](../models/model-binding.md).</span></span> <span data-ttu-id="220a7-129">Gli unit test risultano in genere facili da creare e rapidi da eseguire, in quanto verificano un solo aspetto.</span><span class="sxs-lookup"><span data-stu-id="220a7-129">By focusing on testing just one thing, unit tests are generally simple to write and quick to run.</span></span> <span data-ttu-id="220a7-130">Un set di unit test ben organizzato può essere eseguito spesso senza sovraccarichi eccessivi.</span><span class="sxs-lookup"><span data-stu-id="220a7-130">A well-written set of unit tests can be run frequently without much overhead.</span></span> <span data-ttu-id="220a7-131">Tuttavia gli unit test non rilevano i problemi dell'interazione tra componenti: a questo scopo esistono i [test di integrazione](xref:mvc/controllers/testing#integration-testing).</span><span class="sxs-lookup"><span data-stu-id="220a7-131">However, unit tests don't detect issues in the interaction between components, which is the purpose of [integration tests](xref:mvc/controllers/testing#integration-testing).</span></span>

<span data-ttu-id="220a7-132">Se si scrivono filtri personalizzati, route personalizzate e così via è importante sottoporli a unit test, ma non nel quadro dei test relativi a una determinata azione del controller.</span><span class="sxs-lookup"><span data-stu-id="220a7-132">If you're writing custom filters, routes, etc, you should unit test them, but not as part of your tests on a particular controller action.</span></span> <span data-ttu-id="220a7-133">Il test di questi elementi va eseguito in isolamento.</span><span class="sxs-lookup"><span data-stu-id="220a7-133">They should be tested in isolation.</span></span>

> [!TIP]
> <span data-ttu-id="220a7-134">[Creare ed eseguire unit test con Visual Studio](/visualstudio/test/unit-test-your-code).</span><span class="sxs-lookup"><span data-stu-id="220a7-134">[Create and run unit tests with Visual Studio](/visualstudio/test/unit-test-your-code).</span></span>

<span data-ttu-id="220a7-135">Per una dimostrazione di unit test, esaminare il controller seguente.</span><span class="sxs-lookup"><span data-stu-id="220a7-135">To demonstrate unit testing, review the following controller.</span></span> <span data-ttu-id="220a7-136">Il controller visualizza un elenco di sessioni di brainstorming e consente di creare nuove sessioni con un elemento POST:</span><span class="sxs-lookup"><span data-stu-id="220a7-136">It displays a list of brainstorming sessions and allows new brainstorming sessions to be created with a POST:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/HomeController.cs?highlight=12,16,21,42,43)]

<span data-ttu-id="220a7-137">Il controller si basa sul [principio delle dipendenze esplicite](http://deviq.com/explicit-dependencies-principle/) e prevede di ricevere un'istanza di `IBrainstormSessionRepository` come conseguenza dell'inserimento di dipendenze.</span><span class="sxs-lookup"><span data-stu-id="220a7-137">The controller is following the [explicit dependencies principle](http://deviq.com/explicit-dependencies-principle/), expecting dependency injection to provide it with an instance of `IBrainstormSessionRepository`.</span></span> <span data-ttu-id="220a7-138">Di conseguenza è relativamente semplice eseguire il test con il framework di un oggetto fittizio, ad esempio [Moq](https://www.nuget.org/packages/Moq/).</span><span class="sxs-lookup"><span data-stu-id="220a7-138">This makes it fairly easy to test using a mock object framework, like [Moq](https://www.nuget.org/packages/Moq/).</span></span> <span data-ttu-id="220a7-139">Il metodo `HTTP GET Index` non dispone di cicli o rami e chiama un solo metodo.</span><span class="sxs-lookup"><span data-stu-id="220a7-139">The `HTTP GET Index` method has no looping or branching and only calls one method.</span></span> <span data-ttu-id="220a7-140">Per il test di questo metodo `Index` è necessario verificare che venga restituito un elemento `ViewResult` con un `ViewModel` dal metodo `List` del repository.</span><span class="sxs-lookup"><span data-stu-id="220a7-140">To test this `Index` method, we need to verify that a `ViewResult` is returned, with a `ViewModel` from the repository's `List` method.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=17-18&range=1-33,76-95)]

<span data-ttu-id="220a7-141">Il metodo `HomeController` `HTTP POST Index` (visualizzato sopra) deve verificare quanto segue:</span><span class="sxs-lookup"><span data-stu-id="220a7-141">The `HomeController` `HTTP POST Index` method (shown above) should verify:</span></span>

* <span data-ttu-id="220a7-142">Il metodo di azione restituisce un `ViewResult` di tipo Richiesta non valida con i dati appropriati quando `ModelState.IsValid` è `false`</span><span class="sxs-lookup"><span data-stu-id="220a7-142">The action method returns a Bad Request `ViewResult` with the appropriate data when `ModelState.IsValid` is `false`</span></span>

* <span data-ttu-id="220a7-143">Viene chiamato il metodo `Add` del repository e viene restituito un `RedirectToActionResult` con gli argomenti appropriati quando `ModelState.IsValid` è true.</span><span class="sxs-lookup"><span data-stu-id="220a7-143">The `Add` method on the repository is called and a `RedirectToActionResult` is returned with the correct arguments when `ModelState.IsValid` is true.</span></span>

<span data-ttu-id="220a7-144">È possibile eseguire il test dello stato del modello non valido aggiungendo gli errori con `AddModelError` come illustrato nel primo test riportato di seguito.</span><span class="sxs-lookup"><span data-stu-id="220a7-144">Invalid model state can be tested by adding errors using `AddModelError` as shown in the first test below.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=8,15-16,37-39&range=35-75)]

<span data-ttu-id="220a7-145">Il primo test conferma quando `ModelState` non è valido e restituisce lo stesso risultato `ViewResult` ottenuto in una richiesta `GET`.</span><span class="sxs-lookup"><span data-stu-id="220a7-145">The first test confirms when `ModelState` isn't valid, the same `ViewResult` is returned as for a `GET` request.</span></span> <span data-ttu-id="220a7-146">Si noti che il test non prova a passare un modello non valido.</span><span class="sxs-lookup"><span data-stu-id="220a7-146">Note that the test doesn't attempt to pass in an invalid model.</span></span> <span data-ttu-id="220a7-147">L'operazione non funzionerebbe in ogni caso, dato che l'associazione di modelli non è in esecuzione (tuttavia un [test di integrazione](xref:mvc/controllers/testing#integration-testing) userebbe l'associazione di modelli dell'esercizio).</span><span class="sxs-lookup"><span data-stu-id="220a7-147">That wouldn't work anyway since model binding isn't running (though an [integration test](xref:mvc/controllers/testing#integration-testing) would use exercise model binding).</span></span> <span data-ttu-id="220a7-148">In questo caso, l'associazione di modelli non viene sottoposta a test.</span><span class="sxs-lookup"><span data-stu-id="220a7-148">In this case, model binding isn't being tested.</span></span> <span data-ttu-id="220a7-149">Questi unit test verificano solo le operazioni eseguite dal codice del metodo di azione.</span><span class="sxs-lookup"><span data-stu-id="220a7-149">These unit tests are only testing what the code in the action method does.</span></span>

<span data-ttu-id="220a7-150">Il secondo test verifica che quando `ModelState` è valido viene aggiunto un nuovo elemento `BrainstormSession` (tramite il repository) e il metodo restituisce un elemento `RedirectToActionResult` con le proprietà previste.</span><span class="sxs-lookup"><span data-stu-id="220a7-150">The second test verifies that when `ModelState` is valid, a new `BrainstormSession` is added (via the repository), and the method returns a `RedirectToActionResult` with the expected properties.</span></span> <span data-ttu-id="220a7-151">Le chiamate fittizie che non vengono attivate sono in genere ignorate, ma la chiamata di `Verifiable` al termine della chiamata setup consente di verificarle nel test.</span><span class="sxs-lookup"><span data-stu-id="220a7-151">Mocked calls that aren't called are normally ignored, but calling `Verifiable` at the end of the setup call allows it to be verified in the test.</span></span> <span data-ttu-id="220a7-152">Questa operazione viene eseguita con la chiamata a `mockRepo.Verify`, che non supera il test se non è stato chiamato il metodo previsto.</span><span class="sxs-lookup"><span data-stu-id="220a7-152">This is done with the call to `mockRepo.Verify`, which will fail the test if the expected method wasn't called.</span></span>

> [!NOTE]
> <span data-ttu-id="220a7-153">La libreria Moq usata in questo esempio facilita la combinazione di simulazioni verificabili o "rigide" con simulazioni non verificabili (dette anche simulazioni "generiche" o stub "generici").</span><span class="sxs-lookup"><span data-stu-id="220a7-153">The Moq library used in this sample makes it easy to mix verifiable, or "strict", mocks with non-verifiable mocks (also called "loose" mocks or stubs).</span></span> <span data-ttu-id="220a7-154">Altre informazioni sulla [personalizzazione del comportamento di simulazione con Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span><span class="sxs-lookup"><span data-stu-id="220a7-154">Learn more about [customizing Mock behavior with Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span></span>

<span data-ttu-id="220a7-155">Un altro controller dell'app visualizza informazioni correlate a una sessione di brainstorming specifica.</span><span class="sxs-lookup"><span data-stu-id="220a7-155">Another controller in the app displays information related to a particular brainstorming session.</span></span> <span data-ttu-id="220a7-156">Include logica per gestire i valori ID non validi:</span><span class="sxs-lookup"><span data-stu-id="220a7-156">It includes some logic to deal with invalid id values:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/SessionController.cs?highlight=19,20,21,22,25,26,27,28)]

<span data-ttu-id="220a7-157">L'azione del controller deve eseguire il test di tre casi, uno per ogni istruzione `return`:</span><span class="sxs-lookup"><span data-stu-id="220a7-157">The controller action has three cases to test, one for each `return` statement:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/SessionControllerTests.cs?highlight=27,28,29,46,47,64,65,66,67,68)]

<span data-ttu-id="220a7-158">L'app espone la funzionalità di un'API Web (un elenco di idee associate a una sessione di brainstorming e un metodo per aggiungere nuove idee a una sessione):</span><span class="sxs-lookup"><span data-stu-id="220a7-158">The app exposes functionality as a web API (a list of ideas associated with a brainstorming session and a method for adding new ideas to a session):</span></span>

<a name="ideas-controller"></a>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Api/IdeasController.cs?highlight=21,22,27,30,31,32,33,34,35,36,41,42,46,52,65)]

<span data-ttu-id="220a7-159">Il metodo `ForSession` restituisce un elenco di tipi `IdeaDTO`.</span><span class="sxs-lookup"><span data-stu-id="220a7-159">The `ForSession` method returns a list of `IdeaDTO` types.</span></span> <span data-ttu-id="220a7-160">Evitare di restituire direttamente le entità di dominio aziendali tramite chiamate API, poiché spesso includono più dati di quelli richiesti dal client API e associano senza necessità il modello di dominio interno dell'app con l'API esposta esternamente.</span><span class="sxs-lookup"><span data-stu-id="220a7-160">Avoid returning your business domain entities directly via API calls, since frequently they include more data than the API client requires, and they unnecessarily couple your app's internal domain model with the API you expose externally.</span></span> <span data-ttu-id="220a7-161">Il mapping tra le entità di dominio e i tipi restituiti in rete può essere eseguito manualmente (usando un LINQ `Select` come illustrato di seguito) o tramite una libreria come [AutoMapper](https://github.com/AutoMapper/AutoMapper).</span><span class="sxs-lookup"><span data-stu-id="220a7-161">Mapping between domain entities and the types you will return over the wire can be done manually (using a LINQ `Select` as shown here) or using a library like [AutoMapper](https://github.com/AutoMapper/AutoMapper)</span></span>

<span data-ttu-id="220a7-162">Unit test per i metodi dell'API `Create` e `ForSession`:</span><span class="sxs-lookup"><span data-stu-id="220a7-162">The unit tests for the `Create` and `ForSession` API methods:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/ApiIdeasControllerTests.cs?highlight=18,23,29,33,38-39,43,50,58-59,68-70,76-78&range=1-83,121-135)]

<span data-ttu-id="220a7-163">Come indicato in precedenza, per il test del comportamento del metodo quando `ModelState` non è valido, aggiungere un errore del modello al controller come parte del test.</span><span class="sxs-lookup"><span data-stu-id="220a7-163">As stated previously, to test the behavior of the method when `ModelState` is invalid, add a model error to the controller as part of the test.</span></span> <span data-ttu-id="220a7-164">Non provare il test della convalida o dell'associazione di modelli negli unit test. Eseguire solo il test del comportamento del metodo di azione rispetto a un valore `ModelState` specifico.</span><span class="sxs-lookup"><span data-stu-id="220a7-164">Don't try to test model validation or model binding in your unit tests - just test your action method's behavior when confronted with a particular `ModelState` value.</span></span>

<span data-ttu-id="220a7-165">Il secondo test dipende dal fatto che il repository restituisca null, pertanto il repository fittizio è configurato per restituire null.</span><span class="sxs-lookup"><span data-stu-id="220a7-165">The second test depends on the repository returning null, so the mock repository is configured to return null.</span></span> <span data-ttu-id="220a7-166">Non è necessario creare un database di test (in memoria o con un altro approccio) e creare una query che restituisca questo risultato: l'operazione può essere eseguita in una singola istruzione, come indicato.</span><span class="sxs-lookup"><span data-stu-id="220a7-166">There's no need to create a test database (in memory or otherwise) and construct a query that will return this result - it can be done in a single statement as shown.</span></span>

<span data-ttu-id="220a7-167">L'ultimo test verifica che venga chiamato il metodo `Update` del repository.</span><span class="sxs-lookup"><span data-stu-id="220a7-167">The last test verifies that the repository's `Update` method is called.</span></span> <span data-ttu-id="220a7-168">Come in precedenza, la simulazione viene chiamata con `Verifiable` e quindi il viene chiamato il metodo `Verify` del repository fittizio per confermare che il metodo verificabile sia stato eseguito.</span><span class="sxs-lookup"><span data-stu-id="220a7-168">As we did previously, the mock is called with `Verifiable` and then the mocked repository's `Verify` method is called to confirm the verifiable method was executed.</span></span> <span data-ttu-id="220a7-169">Non spetta a un unit test verificare che il metodo `Update` abbia salvato i dati. Questo compito può essere eseguito con un test di integrazione.</span><span class="sxs-lookup"><span data-stu-id="220a7-169">It's not a unit test responsibility to ensure that the `Update` method saved the data; that can be done with an integration test.</span></span>

## <a name="integration-testing"></a><span data-ttu-id="220a7-170">Test di integrazione</span><span class="sxs-lookup"><span data-stu-id="220a7-170">Integration testing</span></span>

<span data-ttu-id="220a7-171">I [test di integrazione](xref:test/integration-tests) vengono eseguiti per verificare che moduli separati dell'app interagiscano correttamente.</span><span class="sxs-lookup"><span data-stu-id="220a7-171">[Integration tests](xref:test/integration-tests) is done to ensure separate modules within your app work correctly together.</span></span> <span data-ttu-id="220a7-172">In generale tutto ciò che è possibile verificare con uno unit test può essere verificato anche con un test di integrazione, ma non viceversa.</span><span class="sxs-lookup"><span data-stu-id="220a7-172">Generally, anything you can test with a unit test, you can also test with an integration test, but the reverse isn't true.</span></span> <span data-ttu-id="220a7-173">I test di integrazione tendono tuttavia a essere molto più lenti degli unit test.</span><span class="sxs-lookup"><span data-stu-id="220a7-173">However, integration tests tend to be much slower than unit tests.</span></span> <span data-ttu-id="220a7-174">Pertanto è consigliabile verificare tutti gli elementi possibili con unit test e limitare i test di integrazione agli scenari che coinvolgono più collaboratori.</span><span class="sxs-lookup"><span data-stu-id="220a7-174">Thus, it's best to test whatever you can with unit tests, and use integration tests for scenarios that involve multiple collaborators.</span></span>

<span data-ttu-id="220a7-175">Anche se possono risultare utili, gli oggetti fittizi vengono usati di rado nei test di integrazione.</span><span class="sxs-lookup"><span data-stu-id="220a7-175">Although they may still be useful, mock objects are rarely used in integration tests.</span></span> <span data-ttu-id="220a7-176">Negli unit test gli oggetti fittizi sono un metodo efficace per verificare il comportamento previsto dei collaboratori all'esterno dell'unità oggetto del test.</span><span class="sxs-lookup"><span data-stu-id="220a7-176">In unit testing, mock objects are an effective way to control how collaborators outside of the unit being tested should behave for the purposes of the test.</span></span> <span data-ttu-id="220a7-177">In un test di integrazione vengono usati collaboratori reali per confermare che l'intero sottosistema interagisca correttamente.</span><span class="sxs-lookup"><span data-stu-id="220a7-177">In an integration test, real collaborators are used to confirm the whole subsystem works together correctly.</span></span>

### <a name="application-state"></a><span data-ttu-id="220a7-178">Stato dell'applicazione</span><span class="sxs-lookup"><span data-stu-id="220a7-178">Application state</span></span>

<span data-ttu-id="220a7-179">Una considerazione importante quando si eseguono test di integrazione è la modalità di impostazione dello stato dell'app.</span><span class="sxs-lookup"><span data-stu-id="220a7-179">One important consideration when performing integration testing is how to set your app's state.</span></span> <span data-ttu-id="220a7-180">I test vanno eseguiti indipendentemente l'uno dall'altro, pertanto ogni test deve iniziare con l'app in uno stato noto.</span><span class="sxs-lookup"><span data-stu-id="220a7-180">Tests need to run independent of one another, and so each test should start with the app in a known state.</span></span> <span data-ttu-id="220a7-181">Se l'app non usa un database o non dispone di persistenza, questo non dovrebbe rappresentare un problema.</span><span class="sxs-lookup"><span data-stu-id="220a7-181">If your app doesn't use a database or have any persistence, this may not be an issue.</span></span> <span data-ttu-id="220a7-182">Tuttavia la maggior parte delle app reali gestisce la persistenza del proprio stato in un archivio dati, pertanto le modifiche apportate da un test possono influire su un altro test se l'archivio dati non viene reimpostato.</span><span class="sxs-lookup"><span data-stu-id="220a7-182">However, most real-world apps persist their state to some kind of data store, so any modifications made by one test could impact another test unless the data store is reset.</span></span> <span data-ttu-id="220a7-183">Se si usa l'elemento `TestServer` incorporato, l'hosting delle app ASP.NET Core nei test di integrazione è intuitivo, ma non garantisce necessariamente l'accesso ai dati che verranno usati.</span><span class="sxs-lookup"><span data-stu-id="220a7-183">Using the built-in `TestServer`, it's very straightforward to host ASP.NET Core apps within our integration tests, but that doesn't necessarily grant access to the data it will use.</span></span> <span data-ttu-id="220a7-184">Se si usa un database, un approccio possibile è fare connettere l'app a un database di test accessibile anche dai test, quindi verificare venga reimpostato su uno stato noto prima dell'esecuzione di ogni singolo test.</span><span class="sxs-lookup"><span data-stu-id="220a7-184">If you're using an actual database, one approach is to have the app connect to a test database, which your tests can access and ensure is reset to a known state before each test executes.</span></span>

<span data-ttu-id="220a7-185">In questa applicazione di esempio si usa il supporto InMemoryDatabase di Entity Framework Core, pertanto non è possibile stabilire la connessione direttamente dal progetto di test.</span><span class="sxs-lookup"><span data-stu-id="220a7-185">In this sample application, I'm using Entity Framework Core's InMemoryDatabase support, so I can't just connect to it from my test project.</span></span> <span data-ttu-id="220a7-186">Invece si espone un metodo `InitializeDatabase` della classe `Startup` che viene chiamato all'avvio dell'app se si trova nell'ambiente `Development`.</span><span class="sxs-lookup"><span data-stu-id="220a7-186">Instead, I expose an `InitializeDatabase` method from the app's `Startup` class, which I call when the app starts up if it's in the `Development` environment.</span></span> <span data-ttu-id="220a7-187">I test di integrazione traggono automaticamente vantaggio da questa situazione se impostano l'ambiente su `Development`.</span><span class="sxs-lookup"><span data-stu-id="220a7-187">My integration tests automatically benefit from this as long as they set the environment to `Development`.</span></span> <span data-ttu-id="220a7-188">Non è necessario preoccuparsi di reimpostare il database, poiché InMemoryDatabase viene reimpostato ad ogni riavvio dell'app.</span><span class="sxs-lookup"><span data-stu-id="220a7-188">I don't have to worry about resetting the database, since the InMemoryDatabase is reset each time the app restarts.</span></span>

<span data-ttu-id="220a7-189">La classe `Startup`:</span><span class="sxs-lookup"><span data-stu-id="220a7-189">The `Startup` class:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Startup.cs?highlight=19,20,34,35,43,52)]

<span data-ttu-id="220a7-190">Il metodo `GetTestSession` viene usato spesso nei test di integrazione che seguono.</span><span class="sxs-lookup"><span data-stu-id="220a7-190">You'll see the `GetTestSession` method used frequently in the integration tests below.</span></span>

### <a name="accessing-views"></a><span data-ttu-id="220a7-191">Accesso alle visualizzazioni</span><span class="sxs-lookup"><span data-stu-id="220a7-191">Accessing views</span></span>

<span data-ttu-id="220a7-192">Ogni classe di test di integrazione configura l'elemento `TestServer` che esegue l'app ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="220a7-192">Each integration test class configures the `TestServer` that will run the ASP.NET Core app.</span></span> <span data-ttu-id="220a7-193">Per impostazione predefinita `TestServer` ospita l'app Web nella cartella in cui è in esecuzione, in questo caso la cartella del progetto di test.</span><span class="sxs-lookup"><span data-stu-id="220a7-193">By default, `TestServer` hosts the web app in the folder where it's running - in this case, the test project folder.</span></span> <span data-ttu-id="220a7-194">Di conseguenza quando si prova il test di azioni del controller che restituiscono `ViewResult` può essere visualizzato questo errore:</span><span class="sxs-lookup"><span data-stu-id="220a7-194">Thus, when you attempt to test controller actions that return `ViewResult`, you may see this error:</span></span>

```
The view 'Index' wasn't found. The following locations were searched:
(list of locations)
```

<span data-ttu-id="220a7-195">Per risolvere questo problema, è necessario configurare la radice del contenuto del server in modo che individui le visualizzazioni del progetto sottoposto a test.</span><span class="sxs-lookup"><span data-stu-id="220a7-195">To correct this issue, you need to configure the server's content root, so it can locate the views for the project being tested.</span></span> <span data-ttu-id="220a7-196">Questa operazione viene eseguita mediante una chiamata a `UseContentRoot` nella classe `TestFixture`, visualizzata di seguito:</span><span class="sxs-lookup"><span data-stu-id="220a7-196">This is done by a call to `UseContentRoot` in the `TestFixture` class, shown below:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/IntegrationTests/TestFixture.cs?highlight=30,33)]

<span data-ttu-id="220a7-197">La classe `TestFixture` è responsabile della configurazione e della creazione di `TestServer` e imposta un `HttpClient` per comunicare con `TestServer`.</span><span class="sxs-lookup"><span data-stu-id="220a7-197">The `TestFixture` class is responsible for configuring and creating the `TestServer`, setting up an `HttpClient` to communicate with the `TestServer`.</span></span> <span data-ttu-id="220a7-198">Ogni test di integrazione usa la proprietà `Client` per connettersi al server di test e creare una richiesta.</span><span class="sxs-lookup"><span data-stu-id="220a7-198">Each of the integration tests uses the `Client` property to connect to the test server and make a request.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/IntegrationTests/HomeControllerTests.cs?highlight=20,26,29,30,31,35,38,39,40,41,44,47,48)]

<span data-ttu-id="220a7-199">Nel primo dei test precedenti `responseString` contiene il codice HTML sottoposto a rendering della vista, che può essere verificato per confermare che contenga i risultati previsti.</span><span class="sxs-lookup"><span data-stu-id="220a7-199">In the first test above, the `responseString` holds the actual rendered HTML from the View, which can be inspected to confirm it contains expected results.</span></span>

<span data-ttu-id="220a7-200">Il secondo test costruisce un'operazione POST del modulo con un nome di sessione univoco e lo pubblica (POST) nell'app, quindi verifica che venga restituito il reindirizzamento previsto.</span><span class="sxs-lookup"><span data-stu-id="220a7-200">The second test constructs a form POST with a unique session name and POSTs it to the app, then verifies that the expected redirect is returned.</span></span>

### <a name="api-methods"></a><span data-ttu-id="220a7-201">Metodi dell'API</span><span class="sxs-lookup"><span data-stu-id="220a7-201">API methods</span></span>

<span data-ttu-id="220a7-202">Se l'app espone API Web, è consigliabile impostare test automatizzati per confermare che le API vengano eseguite come previsto.</span><span class="sxs-lookup"><span data-stu-id="220a7-202">If your app exposes web APIs, it's a good idea to have automated tests confirm they execute as expected.</span></span> <span data-ttu-id="220a7-203">L'elemento `TestServer` predefinito semplifica il test delle API Web.</span><span class="sxs-lookup"><span data-stu-id="220a7-203">The built-in `TestServer` makes it easy to test web APIs.</span></span> <span data-ttu-id="220a7-204">Se i metodi API usano l'associazione di modelli è necessario controllare sempre `ModelState.IsValid`. I test di integrazione sono lo strumento ottimale per confermare che la convalida del modello funzioni correttamente.</span><span class="sxs-lookup"><span data-stu-id="220a7-204">If your API methods are using model binding, you should always check `ModelState.IsValid`, and integration tests are the right place to confirm that your model validation is working properly.</span></span>

<span data-ttu-id="220a7-205">Il seguente set di test opera sul metodo `Create` nella classe [IdeasController](xref:mvc/controllers/testing#ideas-controller) illustrata in precedenza:</span><span class="sxs-lookup"><span data-stu-id="220a7-205">The following set of tests target the `Create` method in the [IdeasController](xref:mvc/controllers/testing#ideas-controller) class shown above:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/IntegrationTests/ApiIdeasControllerTests.cs)]

<span data-ttu-id="220a7-206">A differenza dei test di integrazione delle azioni che restituiscono visualizzazioni HTML, i metodi per le API Web che restituiscono risultati sono in genere deserializzabili come oggetti fortemente tipizzati, come illustrato nell'ultimo dei test precedenti.</span><span class="sxs-lookup"><span data-stu-id="220a7-206">Unlike integration tests of actions that returns HTML views, web API methods that return results can usually be deserialized as strongly typed objects, as the last test above shows.</span></span> <span data-ttu-id="220a7-207">In questo caso il test deserializza il risultato in un'istanza `BrainstormSession` e conferma che l'idea è stata aggiunta correttamente alla relativa raccolta di idee.</span><span class="sxs-lookup"><span data-stu-id="220a7-207">In this case, the test deserializes the result to a `BrainstormSession` instance, and confirms that the idea was correctly added to its collection of ideas.</span></span>

<span data-ttu-id="220a7-208">Altri esempi di test di integrazione sono disponibili nel [progetto di esempio](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample) di questo articolo.</span><span class="sxs-lookup"><span data-stu-id="220a7-208">You'll find additional examples of integration tests in this article's [sample project](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample).</span></span>
