---
title: Test della logica dei controller in ASP.NET Core
author: ardalis
description: Informazioni sul test della logica dei controller in ASP.NET Core con Moq e xUnit.
ms.author: riande
ms.date: 10/14/2016
uid: mvc/controllers/testing
ms.openlocfilehash: d0b2a25d00187c088671be147844aa892f824c6e
ms.sourcegitcommit: 64c2ca86fff445944b155635918126165ee0f8aa
ms.translationtype: HT
ms.contentlocale: it-IT
ms.lasthandoff: 08/18/2018
ms.locfileid: "41751504"
---
# <a name="test-controller-logic-in-aspnet-core"></a><span data-ttu-id="e1ee3-103">Test della logica dei controller in ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="e1ee3-103">Test controller logic in ASP.NET Core</span></span>

<span data-ttu-id="e1ee3-104">Di [Steve Smith](https://ardalis.com/)</span><span class="sxs-lookup"><span data-stu-id="e1ee3-104">By [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="e1ee3-105">I controller sono un componente essenziale di qualsiasi applicazione ASP.NET Core MVC.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-105">Controllers are a central part of any ASP.NET Core MVC application.</span></span> <span data-ttu-id="e1ee3-106">Di conseguenza è importante verificare che funzionino correttamente nell'app.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-106">As such, you should have confidence they behave as intended for your app.</span></span> <span data-ttu-id="e1ee3-107">I test automatizzati eseguono questa verifica e rilevano gli errori dei controller prima che questi raggiungano la fase di produzione.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-107">Automated tests can provide you with this confidence and can detect errors before they reach production.</span></span> <span data-ttu-id="e1ee3-108">È importante evitare di includere responsabilità non necessarie nei controller e verificare che i test riguardino esclusivamente le responsabilità dei controller.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-108">It's important to avoid placing unnecessary responsibilities within your controllers and ensure your tests focus only on controller responsibilities.</span></span>

<span data-ttu-id="e1ee3-109">La logica del controller deve essere minima e non incentrata su logica di business o aspetti dell'infrastruttura (ad esempio l'accesso ai dati).</span><span class="sxs-lookup"><span data-stu-id="e1ee3-109">Controller logic should be minimal and not be focused on business logic or infrastructure concerns (for example, data access).</span></span> <span data-ttu-id="e1ee3-110">Il test deve riguardare la logica del controller e non il framework.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-110">Test controller logic, not the framework.</span></span> <span data-ttu-id="e1ee3-111">Eseguire test del *comportamento* del controller con input validi e non validi.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-111">Test how the controller *behaves* based on valid or invalid inputs.</span></span> <span data-ttu-id="e1ee3-112">Eseguire il test delle risposte del controller in base ai risultati dell'operazione di business effettuata dal controller.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-112">Test controller responses based on the result of the business operation it performs.</span></span>

<span data-ttu-id="e1ee3-113">Responsabilità tipiche del controller:</span><span class="sxs-lookup"><span data-stu-id="e1ee3-113">Typical controller responsibilities:</span></span>

* <span data-ttu-id="e1ee3-114">Verificare `ModelState.IsValid`.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-114">Verify `ModelState.IsValid`.</span></span>
* <span data-ttu-id="e1ee3-115">Restituire un errore se `ModelState` non è valido.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-115">Return an error response if `ModelState` is invalid.</span></span>
* <span data-ttu-id="e1ee3-116">Recuperare un'entità di business dalla persistenza.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-116">Retrieve a business entity from persistence.</span></span>
* <span data-ttu-id="e1ee3-117">Eseguire un'azione nell'entità di business.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-117">Perform an action on the business entity.</span></span>
* <span data-ttu-id="e1ee3-118">Salvare l'entità di business nella persistenza.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-118">Save the business entity to persistence.</span></span>
* <span data-ttu-id="e1ee3-119">Restituire un risultato `IActionResult` appropriato.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-119">Return an appropriate `IActionResult`.</span></span>

<span data-ttu-id="e1ee3-120">[Visualizzare o scaricare il codice di esempio](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample) ([procedura per il download](xref:tutorials/index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="e1ee3-120">[View or download sample code](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample) ([how to download](xref:tutorials/index#how-to-download-a-sample))</span></span>

## <a name="unit-tests-of-controller-logic"></a><span data-ttu-id="e1ee3-121">Unit test della logica dei controller</span><span class="sxs-lookup"><span data-stu-id="e1ee3-121">Unit tests of controller logic</span></span>

<span data-ttu-id="e1ee3-122">Gli [unit test](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) implicano l'esecuzione di test su una parte di un'app isolandola dall'infrastruttura e dalle dipendenze.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-122">[Unit tests](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) involve testing a part of an app in isolation from its infrastructure and dependencies.</span></span> <span data-ttu-id="e1ee3-123">Quando si sottopone a unit test la logica del controller, si verifica solo il contenuto di una singola azione e non il comportamento delle relative dipendenze o del framework.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-123">When unit testing controller logic, only the contents of a single action is tested, not the behavior of its dependencies or of the framework itself.</span></span> <span data-ttu-id="e1ee3-124">Quando si sottopongono a unit test le azioni del controller, è importante concentrarsi esclusivamente sul funzionamento del controller.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-124">As you unit test your controller actions, make sure you focus only on its behavior.</span></span> <span data-ttu-id="e1ee3-125">Uno unit test del controller non prende in esame elementi come [filtri](xref:mvc/controllers/filters), [routing](xref:fundamentals/routing) o [associazione di modelli](xref:mvc/models/model-binding).</span><span class="sxs-lookup"><span data-stu-id="e1ee3-125">A controller unit test avoids things like [filters](xref:mvc/controllers/filters), [routing](xref:fundamentals/routing), or [model binding](xref:mvc/models/model-binding).</span></span> <span data-ttu-id="e1ee3-126">Gli unit test risultano in genere facili da creare e rapidi da eseguire, in quanto verificano un solo aspetto.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-126">By focusing on testing just one thing, unit tests are generally simple to write and quick to run.</span></span> <span data-ttu-id="e1ee3-127">Un set di unit test ben organizzato può essere eseguito spesso senza sovraccarichi eccessivi.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-127">A well-written set of unit tests can be run frequently without much overhead.</span></span> <span data-ttu-id="e1ee3-128">Tuttavia gli unit test non rilevano i problemi dell'interazione tra componenti: a questo scopo esistono i [test di integrazione](xref:test/integration-tests).</span><span class="sxs-lookup"><span data-stu-id="e1ee3-128">However, unit tests don't detect issues in the interaction between components, which is the purpose of [integration tests](xref:test/integration-tests).</span></span>

<span data-ttu-id="e1ee3-129">Se si scrivono route e filtri personalizzati, è opportuno sottoporli a unit test in isolamento e non durante i test relativi a una determinata azione del controller.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-129">If you're writing custom filters and routes, you should unit test them in isolation, not as part of your tests on a particular controller action.</span></span>

> [!TIP]
> <span data-ttu-id="e1ee3-130">[Creare ed eseguire unit test con Visual Studio](/visualstudio/test/unit-test-your-code).</span><span class="sxs-lookup"><span data-stu-id="e1ee3-130">[Create and run unit tests with Visual Studio](/visualstudio/test/unit-test-your-code).</span></span>

<span data-ttu-id="e1ee3-131">Per una dimostrazione di unit test, esaminare il controller seguente.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-131">To demonstrate unit testing, review the following controller.</span></span> <span data-ttu-id="e1ee3-132">Il controller visualizza un elenco di sessioni di brainstorming e consente di creare nuove sessioni con un elemento POST:</span><span class="sxs-lookup"><span data-stu-id="e1ee3-132">It displays a list of brainstorming sessions and allows new brainstorming sessions to be created with a POST:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/HomeController.cs?highlight=12,16,21,42,43)]

<span data-ttu-id="e1ee3-133">Il controller si basa sul [principio delle dipendenze esplicite](http://deviq.com/explicit-dependencies-principle/) e prevede di ricevere un'istanza di `IBrainstormSessionRepository` come conseguenza dell'inserimento di dipendenze.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-133">The controller is following the [explicit dependencies principle](http://deviq.com/explicit-dependencies-principle/), expecting dependency injection to provide it with an instance of `IBrainstormSessionRepository`.</span></span> <span data-ttu-id="e1ee3-134">Di conseguenza è relativamente semplice eseguire il test con il framework di un oggetto fittizio, ad esempio [Moq](https://www.nuget.org/packages/Moq/).</span><span class="sxs-lookup"><span data-stu-id="e1ee3-134">This makes it fairly easy to test using a mock object framework, like [Moq](https://www.nuget.org/packages/Moq/).</span></span> <span data-ttu-id="e1ee3-135">Il metodo `HTTP GET Index` non dispone di cicli o rami e chiama un solo metodo.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-135">The `HTTP GET Index` method has no looping or branching and only calls one method.</span></span> <span data-ttu-id="e1ee3-136">Per il test di questo metodo `Index` è necessario verificare che venga restituito un elemento `ViewResult` con un `ViewModel` dal metodo `List` del repository.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-136">To test this `Index` method, we need to verify that a `ViewResult` is returned, with a `ViewModel` from the repository's `List` method.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=17-18&range=1-33,76-95)]

<span data-ttu-id="e1ee3-137">Il metodo `HomeController` `HTTP POST Index` (visualizzato sopra) deve verificare quanto segue:</span><span class="sxs-lookup"><span data-stu-id="e1ee3-137">The `HomeController` `HTTP POST Index` method (shown above) should verify:</span></span>

* <span data-ttu-id="e1ee3-138">Il metodo di azione restituisce un elemento `ViewResult` di tipo Richiesta non valida con i dati appropriati quando `ModelState.IsValid` è `false`.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-138">The action method returns a Bad Request `ViewResult` with the appropriate data when `ModelState.IsValid` is `false`.</span></span>

* <span data-ttu-id="e1ee3-139">Viene chiamato il metodo `Add` del repository e viene restituito un `RedirectToActionResult` con gli argomenti appropriati quando `ModelState.IsValid` è true.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-139">The `Add` method on the repository is called and a `RedirectToActionResult` is returned with the correct arguments when `ModelState.IsValid` is true.</span></span>

<span data-ttu-id="e1ee3-140">È possibile eseguire il test dello stato del modello non valido aggiungendo gli errori con `AddModelError` come illustrato nel primo test riportato di seguito.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-140">Invalid model state can be tested by adding errors using `AddModelError` as shown in the first test below.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=8,15-16,37-39&range=35-75)]

<span data-ttu-id="e1ee3-141">Il primo test conferma quando `ModelState` non è valido e restituisce lo stesso risultato `ViewResult` ottenuto in una richiesta `GET`.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-141">The first test confirms when `ModelState` isn't valid, the same `ViewResult` is returned as for a `GET` request.</span></span> <span data-ttu-id="e1ee3-142">Si noti che il test non prova a passare un modello non valido.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-142">Note that the test doesn't attempt to pass in an invalid model.</span></span> <span data-ttu-id="e1ee3-143">L'operazione non funzionerebbe in ogni caso, dato che l'associazione di modelli non è in esecuzione (tuttavia un [test di integrazione](xref:test/integration-tests) userebbe l'associazione di modelli dell'esercizio).</span><span class="sxs-lookup"><span data-stu-id="e1ee3-143">That wouldn't work anyway since model binding isn't running (though an [integration test](xref:test/integration-tests) would use exercise model binding).</span></span> <span data-ttu-id="e1ee3-144">In questo caso, l'associazione di modelli non viene sottoposta a test.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-144">In this case, model binding isn't being tested.</span></span> <span data-ttu-id="e1ee3-145">Questi unit test verificano solo le operazioni eseguite dal codice del metodo di azione.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-145">These unit tests are only testing what the code in the action method does.</span></span>

<span data-ttu-id="e1ee3-146">Il secondo test verifica che quando `ModelState` è valido viene aggiunto un nuovo elemento `BrainstormSession` (tramite il repository) e il metodo restituisce un elemento `RedirectToActionResult` con le proprietà previste.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-146">The second test verifies that when `ModelState` is valid, a new `BrainstormSession` is added (via the repository), and the method returns a `RedirectToActionResult` with the expected properties.</span></span> <span data-ttu-id="e1ee3-147">Le chiamate fittizie che non vengono attivate sono in genere ignorate, ma la chiamata di `Verifiable` al termine della chiamata setup consente di verificarle nel test.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-147">Mocked calls that aren't called are normally ignored, but calling `Verifiable` at the end of the setup call allows it to be verified in the test.</span></span> <span data-ttu-id="e1ee3-148">Questa operazione viene eseguita con la chiamata a `mockRepo.Verify`, che non supera il test se non è stato chiamato il metodo previsto.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-148">This is done with the call to `mockRepo.Verify`, which will fail the test if the expected method wasn't called.</span></span>

> [!NOTE]
> <span data-ttu-id="e1ee3-149">La libreria Moq usata in questo esempio facilita la combinazione di simulazioni verificabili o "rigide" con simulazioni non verificabili (dette anche simulazioni "generiche" o stub "generici").</span><span class="sxs-lookup"><span data-stu-id="e1ee3-149">The Moq library used in this sample makes it easy to mix verifiable, or "strict", mocks with non-verifiable mocks (also called "loose" mocks or stubs).</span></span> <span data-ttu-id="e1ee3-150">Altre informazioni sulla [personalizzazione del comportamento di simulazione con Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span><span class="sxs-lookup"><span data-stu-id="e1ee3-150">Learn more about [customizing Mock behavior with Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span></span>

<span data-ttu-id="e1ee3-151">Un altro controller dell'app visualizza informazioni correlate a una sessione di brainstorming specifica.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-151">Another controller in the app displays information related to a particular brainstorming session.</span></span> <span data-ttu-id="e1ee3-152">Include logica per gestire i valori ID non validi:</span><span class="sxs-lookup"><span data-stu-id="e1ee3-152">It includes some logic to deal with invalid id values:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/SessionController.cs?highlight=19,20,21,22,25,26,27,28)]

<span data-ttu-id="e1ee3-153">L'azione del controller deve eseguire il test di tre casi, uno per ogni istruzione `return`:</span><span class="sxs-lookup"><span data-stu-id="e1ee3-153">The controller action has three cases to test, one for each `return` statement:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/SessionControllerTests.cs?highlight=27,28,29,46,47,64,65,66,67,68)]

<span data-ttu-id="e1ee3-154">L'app espone la funzionalità di un'API Web (un elenco di idee associate a una sessione di brainstorming e un metodo per aggiungere nuove idee a una sessione):</span><span class="sxs-lookup"><span data-stu-id="e1ee3-154">The app exposes functionality as a web API (a list of ideas associated with a brainstorming session and a method for adding new ideas to a session):</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Api/IdeasController.cs?highlight=21,22,27,30,31,32,33,34,35,36,41,42,46,52,65)]

<span data-ttu-id="e1ee3-155">Il metodo `ForSession` restituisce un elenco di tipi `IdeaDTO`.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-155">The `ForSession` method returns a list of `IdeaDTO` types.</span></span> <span data-ttu-id="e1ee3-156">Evitare di restituire direttamente le entità di dominio aziendali tramite chiamate API, poiché spesso includono più dati di quelli richiesti dal client API e associano senza necessità il modello di dominio interno dell'app con l'API esposta esternamente.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-156">Avoid returning your business domain entities directly via API calls, since frequently they include more data than the API client requires, and they unnecessarily couple your app's internal domain model with the API you expose externally.</span></span> <span data-ttu-id="e1ee3-157">Il mapping tra le entità di dominio e i tipi restituiti in rete può essere eseguito manualmente (usando un LINQ `Select` come illustrato di seguito) o tramite una libreria come [AutoMapper](https://github.com/AutoMapper/AutoMapper).</span><span class="sxs-lookup"><span data-stu-id="e1ee3-157">Mapping between domain entities and the types you will return over the wire can be done manually (using a LINQ `Select` as shown here) or using a library like [AutoMapper](https://github.com/AutoMapper/AutoMapper).</span></span>

<span data-ttu-id="e1ee3-158">Unit test per i metodi dell'API `Create` e `ForSession`:</span><span class="sxs-lookup"><span data-stu-id="e1ee3-158">The unit tests for the `Create` and `ForSession` API methods:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/ApiIdeasControllerTests.cs?highlight=18,23,29,33,38-39,43,50,58-59,68-70,76-78&range=1-83,121-135)]

<span data-ttu-id="e1ee3-159">Come indicato in precedenza, per il test del comportamento del metodo quando `ModelState` non è valido, aggiungere un errore del modello al controller come parte del test.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-159">As stated previously, to test the behavior of the method when `ModelState` is invalid, add a model error to the controller as part of the test.</span></span> <span data-ttu-id="e1ee3-160">Non provare il test della convalida o dell'associazione di modelli negli unit test. Eseguire solo il test del comportamento del metodo di azione rispetto a un valore `ModelState` specifico.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-160">Don't try to test model validation or model binding in your unit tests - just test your action method's behavior when confronted with a particular `ModelState` value.</span></span>

<span data-ttu-id="e1ee3-161">Il secondo test dipende dal fatto che il repository restituisca null, pertanto il repository fittizio è configurato per restituire null.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-161">The second test depends on the repository returning null, so the mock repository is configured to return null.</span></span> <span data-ttu-id="e1ee3-162">Non è necessario creare un database di test (in memoria o con un altro approccio) e creare una query che restituisca questo risultato: l'operazione può essere eseguita in una singola istruzione, come indicato.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-162">There's no need to create a test database (in memory or otherwise) and construct a query that will return this result - it can be done in a single statement as shown.</span></span>

<span data-ttu-id="e1ee3-163">L'ultimo test verifica che venga chiamato il metodo `Update` del repository.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-163">The last test verifies that the repository's `Update` method is called.</span></span> <span data-ttu-id="e1ee3-164">Come in precedenza, la simulazione viene chiamata con `Verifiable` e quindi il viene chiamato il metodo `Verify` del repository fittizio per confermare che il metodo verificabile sia stato eseguito.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-164">As we did previously, the mock is called with `Verifiable` and then the mocked repository's `Verify` method is called to confirm the verifiable method was executed.</span></span> <span data-ttu-id="e1ee3-165">Non spetta a un unit test verificare che il metodo `Update` abbia salvato i dati. Questo compito può essere eseguito con un test di integrazione.</span><span class="sxs-lookup"><span data-stu-id="e1ee3-165">It's not a unit test responsibility to ensure that the `Update` method saved the data; that can be done with an integration test.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="e1ee3-166">Risorse aggiuntive</span><span class="sxs-lookup"><span data-stu-id="e1ee3-166">Additional resources</span></span>

* <xref:test/integration-tests>
