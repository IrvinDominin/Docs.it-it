---
uid: aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline
title: Middleware OWIN in IIS è integrata pipeline | Documenti Microsoft
author: Praburaj
description: In questo articolo viene illustrato come eseguire i componenti middleware OWIN (OMCs) nella pipeline integrata di IIS e come impostare l'evento pipeline un OMC viene eseguito su. È necessario...
ms.author: aspnetcontent
manager: wpickett
ms.date: 11/07/2013
ms.topic: article
ms.assetid: d031c021-33c2-45a5-bf9f-98f8fa78c2ab
ms.technology: ''
ms.prod: .net-framework
msc.legacyurl: /aspnet/overview/owin-and-katana/owin-middleware-in-the-iis-integrated-pipeline
msc.type: authoredcontent
ms.openlocfilehash: 5df70c80084a32c5f61ac9288c8cdbfaaa47f124
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 04/06/2018
ms.locfileid: "30871493"
---
<a name="owin-middleware-in-the-iis-integrated-pipeline"></a><span data-ttu-id="4c8f1-104">Middleware OWIN della pipeline integrata di IIS</span><span class="sxs-lookup"><span data-stu-id="4c8f1-104">OWIN Middleware in the IIS integrated pipeline</span></span>
====================
<span data-ttu-id="4c8f1-105">dal [Praburaj Thiagarajan](https://github.com/Praburaj), [Rick Anderson](https://github.com/Rick-Anderson)</span><span class="sxs-lookup"><span data-stu-id="4c8f1-105">by [Praburaj Thiagarajan](https://github.com/Praburaj), [Rick Anderson](https://github.com/Rick-Anderson)</span></span>

> <span data-ttu-id="4c8f1-106">In questo articolo viene illustrato come eseguire i componenti middleware OWIN (OMCs) nella pipeline integrata di IIS e come impostare l'evento pipeline un OMC viene eseguito su.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-106">This article shows how to run OWIN middleware Components (OMCs) in the IIS integrated pipeline, and how to set the pipeline event an OMC runs on.</span></span> <span data-ttu-id="4c8f1-107">È necessario rivedere [una panoramica del progetto Katana](an-overview-of-project-katana.md) e [OWIN avvio classe rilevamento](owin-startup-class-detection.md) prima di leggere questa esercitazione.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-107">You should review [An Overview of Project Katana](an-overview-of-project-katana.md) and [OWIN Startup Class Detection](owin-startup-class-detection.md) before reading this tutorial.</span></span> <span data-ttu-id="4c8f1-108">In questa esercitazione è stato scritto dal Rick Anderson ( [ @RickAndMSFT ](https://twitter.com/#!/RickAndMSFT) ), Chris Ross Praburaj Thiagarajan e Howard Dierking ( [ @howard \_dierking](https://twitter.com/howard_dierking) ).</span><span class="sxs-lookup"><span data-stu-id="4c8f1-108">This tutorial was written by Rick Anderson ( [@RickAndMSFT](https://twitter.com/#!/RickAndMSFT) ), Chris Ross, Praburaj Thiagarajan, and Howard Dierking ( [@howard\_dierking](https://twitter.com/howard_dierking) ).</span></span>


<span data-ttu-id="4c8f1-109">Sebbene [OWIN](an-overview-of-project-katana.md) componenti middleware (OMCs) sono progettati principalmente per l'esecuzione in una pipeline indipendente dal server, è possibile eseguire un OMC della pipeline integrata IIS nonché (**è in modalità classica *non* supportati**).</span><span class="sxs-lookup"><span data-stu-id="4c8f1-109">Although [OWIN](an-overview-of-project-katana.md) middleware components (OMCs) are primarily designed to run in a server-agnostic pipeline, it is possible to run an OMC in the IIS integrated pipeline as well (**classic mode is *not* supported**).</span></span> <span data-ttu-id="4c8f1-110">Per il funzionamento della pipeline integrata di IIS, l'installazione del pacchetto di esempio dal Package Manager Console (PMC), è possibile effettuare un OMC:</span><span class="sxs-lookup"><span data-stu-id="4c8f1-110">An OMC can be made to work in the IIS integrated pipeline by installing the following package from the Package Manager Console (PMC):</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample1.cmd)]

<span data-ttu-id="4c8f1-111">Ciò significa che tutti i framework dell'applicazione, anche quelli che non sono ancora in grado di eseguire di fuori di IIS e System. Web, possono trarre vantaggio da componenti esistenti di middleware OWIN.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-111">This means that all application frameworks, even those that are not yet able to run outside of IIS and System.Web, can benefit from existing OWIN middleware components.</span></span> 

> [!NOTE]
> <span data-ttu-id="4c8f1-112">Tutti i `Microsoft.Owin.Security.*` pacchetti shipping con il nuovo sistema di identità in Visual Studio 2013 (ad esempio: i cookie, Account Microsoft, Google, Facebook, Twitter, [Token di connessione](http://self-issued.info/docs/draft-ietf-oauth-v2-bearer.html), OAuth, server di autorizzazione, JWT, Azure Active Directory e Active directory federation services) vengono creati come OMCs e può essere usato negli scenari self-hosted e ospitati in IIS.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-112">All of the `Microsoft.Owin.Security.*` packages shipping with the new Identity System in Visual Studio 2013 (for example: Cookies, Microsoft Account, Google, Facebook, Twitter, [Bearer Token](http://self-issued.info/docs/draft-ietf-oauth-v2-bearer.html), OAuth, Authorization server, JWT, Azure Active directory, and Active directory federation services) are authored as OMCs, and can be used in both self-hosted and IIS-hosted scenarios.</span></span>

## <a name="how-owin-middleware-executes-in-the-iis-integrated-pipeline"></a><span data-ttu-id="4c8f1-113">Modalità di esecuzione di Middleware OWIN in Pipeline integrata di IIS</span><span class="sxs-lookup"><span data-stu-id="4c8f1-113">How OWIN Middleware Executes in the IIS Integrated Pipeline</span></span>

<span data-ttu-id="4c8f1-114">Per le applicazioni console OWIN, la pipeline dell'applicazione creati utilizzando il [configurazione di avvio](owin-startup-class-detection.md) è impostata in base all'ordine dei componenti vengono aggiunti utilizzando la `IAppBuilder.Use` metodo.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-114">For OWIN console applications, the application pipeline built using the [startup configuration](owin-startup-class-detection.md) is set by the order the components are added using the `IAppBuilder.Use` method.</span></span> <span data-ttu-id="4c8f1-115">Ovvero, la pipeline OWIN nel [Katana](an-overview-of-project-katana.md) runtime elaborerà OMCs nell'ordine in cui sono stati registrati utilizzando `IAppBuilder.Use`.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-115">That is, the OWIN pipeline in the [Katana](an-overview-of-project-katana.md) runtime will process OMCs in the order they were registered using `IAppBuilder.Use`.</span></span> <span data-ttu-id="4c8f1-116">Nella pipeline integrata di IIS la pipeline della richiesta è costituita [HttpModules](https://msdn.microsoft.com/library/ms178468(v=vs.85).aspx) sottoscrivere un set predefinito di eventi della pipeline, ad esempio [BeginRequest](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx), [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx), [AuthorizeRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx)e così via.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-116">In the IIS integrated pipeline the request pipeline consists of [HttpModules](https://msdn.microsoft.com/library/ms178468(v=vs.85).aspx) subscribed to a pre-defined set of the pipeline events such as [BeginRequest](https://msdn.microsoft.com/library/system.web.httpapplication.beginrequest.aspx), [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx), [AuthorizeRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authorizerequest.aspx), etc.</span></span>

<span data-ttu-id="4c8f1-117">Se si confronta un OMC a quello di un [HttpModule](https://msdn.microsoft.com/library/zec9k340(v=vs.85).aspx) nel mondo ASP.NET, un OMC deve essere registrato per l'evento corretto pipeline predefinite.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-117">If we compare an OMC to that of an [HttpModule](https://msdn.microsoft.com/library/zec9k340(v=vs.85).aspx) in the ASP.NET world, an OMC must be registered to the correct pre-defined pipeline event.</span></span> <span data-ttu-id="4c8f1-118">Ad esempio, HttpModule `MyModule` verrà richiamato quando arriva una richiesta il [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx) fase della pipeline:</span><span class="sxs-lookup"><span data-stu-id="4c8f1-118">For example, the HttpModule `MyModule` will get invoked when a request comes to the [AuthenticateRequest](https://msdn.microsoft.com/library/system.web.httpapplication.authenticaterequest.aspx) stage in the pipeline:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample2.cs?highlight=10)]

<span data-ttu-id="4c8f1-119">Affinché un OMC deve far parte di questo ordine di esecuzione stesso, basato su eventi, il [Katana](an-overview-of-project-katana.md) esegue l'analisi del codice runtime tramite il [configurazione di avvio](owin-startup-class-detection.md) e sottoscrive ognuno dei componenti middleware a un eventi pipeline integrata.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-119">In order for an OMC to participate in this same, event-based execution ordering, the [Katana](an-overview-of-project-katana.md) runtime code scans through the [startup configuration](owin-startup-class-detection.md) and subscribes each of the middleware components to an integrated pipeline event.</span></span> <span data-ttu-id="4c8f1-120">Il codice di registrazione e OMC seguente consente ad esempio visualizzare la registrazione di eventi predefiniti di componenti middleware.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-120">For example, the following OMC and registration code enables you to see the default event registration of middleware components.</span></span> <span data-ttu-id="4c8f1-121">(Per ulteriori istruzioni sulla creazione di una classe di avvio OWIN, vedere [OWIN avvio classe rilevamento](owin-startup-class-detection.md).)</span><span class="sxs-lookup"><span data-stu-id="4c8f1-121">(For more detailed instructions on creating an OWIN startup class, see [OWIN Startup Class Detection](owin-startup-class-detection.md).)</span></span>

1. <span data-ttu-id="4c8f1-122">Creare un progetto di applicazione web vuota e denominarla **owin2**.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-122">Create an empty web application project and name it **owin2**.</span></span>
2. <span data-ttu-id="4c8f1-123">Dal Package Manager Console (PMC), eseguire il comando seguente:</span><span class="sxs-lookup"><span data-stu-id="4c8f1-123">From the Package Manager Console (PMC), run the following command:</span></span> 

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample3.cmd)]
3. <span data-ttu-id="4c8f1-124">Aggiungere un `OWIN Startup Class` e denominarlo `Startup`.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-124">Add an `OWIN Startup Class` and name it `Startup`.</span></span> <span data-ttu-id="4c8f1-125">Sostituire il codice generato con il codice seguente (le modifiche vengono evidenziate):</span><span class="sxs-lookup"><span data-stu-id="4c8f1-125">Replace the generated code with the following (the changes are highlighted):</span></span>  

    [!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample4.cs?highlight=5-7,15-36)]
4. <span data-ttu-id="4c8f1-126">Premere F5 per eseguire l'app.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-126">Hit F5 to run the app.</span></span>

<span data-ttu-id="4c8f1-127">La configurazione di avvio impostato una pipeline con middleware tre componenti, i primi due la visualizzazione di informazioni di diagnostica e l'ultima risposta agli eventi (e anche la visualizzazione di informazioni di diagnostica).</span><span class="sxs-lookup"><span data-stu-id="4c8f1-127">The Startup configuration sets up a pipeline with three middleware components, the first two displaying diagnostic information and the last one responding to events (and also displaying diagnostic information).</span></span> <span data-ttu-id="4c8f1-128">Il `PrintCurrentIntegratedPipelineStage` metodo consente di visualizzare l'evento di pipeline integrata in cui viene richiamato questo middleware e un messaggio.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-128">The `PrintCurrentIntegratedPipelineStage` method displays the integrated pipeline event this middleware is invoked on and a message.</span></span> <span data-ttu-id="4c8f1-129">L'output verrà visualizzato quanto segue:</span><span class="sxs-lookup"><span data-stu-id="4c8f1-129">The output windows displays the following:</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample5.cmd)]

<span data-ttu-id="4c8f1-130">Il runtime Katana eseguito il mapping di ogni componente middleware OWIN per [PreExecuteRequestHandler](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx) per impostazione predefinita, che corrisponde all'evento di pipeline IIS [PreRequestHandlerExecute](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx).</span><span class="sxs-lookup"><span data-stu-id="4c8f1-130">The Katana runtime mapped each of the OWIN middleware components to [PreExecuteRequestHandler](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx) by default, which corresponds to the IIS pipeline event [PreRequestHandlerExecute](https://msdn.microsoft.com/library/system.web.httpapplication.prerequesthandlerexecute.aspx).</span></span>

## <a name="stage-markers"></a><span data-ttu-id="4c8f1-131">Fase marcatori</span><span class="sxs-lookup"><span data-stu-id="4c8f1-131">Stage Markers</span></span>

<span data-ttu-id="4c8f1-132">È possibile contrassegnare OMCs da eseguire in specifiche fasi della pipeline utilizzando il `IAppBuilder UseStageMarker()` metodo di estensione.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-132">You can mark OMCs to execute at specific stages of the pipeline by using the `IAppBuilder UseStageMarker()` extension method.</span></span> <span data-ttu-id="4c8f1-133">Per eseguire un set di componenti middleware durante una determinata fase, inserire un marcatore di fasi subito dopo l'ultimo componente impostato durante la registrazione.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-133">To run a set of middleware components during a particular stage, insert a stage marker right after the last component is the set during registration.</span></span> <span data-ttu-id="4c8f1-134">Esistono regole in quale fase della pipeline è possibile eseguire middleware e devono eseguire i componenti dell'ordine (le regole sono illustrate più avanti nell'esercitazione).</span><span class="sxs-lookup"><span data-stu-id="4c8f1-134">There are rules on which stage of the pipeline you can execute middleware and the order components must run (The rules are explained later in the tutorial).</span></span> <span data-ttu-id="4c8f1-135">Aggiungere il `UseStageMarker` metodo il `Configuration` codice come illustrato di seguito:</span><span class="sxs-lookup"><span data-stu-id="4c8f1-135">Add the `UseStageMarker` method to the `Configuration` code as shown below:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample6.cs?highlight=13,19)]

<span data-ttu-id="4c8f1-136">Il `app.UseStageMarker(PipelineStage.Authenticate)` chiamata consente di configurare tutti i componenti middleware registrato in precedenza (in questo caso, i due componenti diagnostica) per l'esecuzione in fase di autenticazione della pipeline.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-136">The `app.UseStageMarker(PipelineStage.Authenticate)` call configures all the previously registered middleware components (in this case, our two diagnostic components) to run on the authentication stage of the pipeline.</span></span> <span data-ttu-id="4c8f1-137">L'ultimo componente middleware (che consente di visualizzare la diagnostica e risponde alle richieste) verrà eseguito il `ResolveCache` fase (il [ResolveRequestCache](https://msdn.microsoft.com/library/system.web.httpapplication.resolverequestcache.aspx) evento).</span><span class="sxs-lookup"><span data-stu-id="4c8f1-137">The last middleware component (which displays diagnostics and responds to requests) will run on the `ResolveCache` stage (the [ResolveRequestCache](https://msdn.microsoft.com/library/system.web.httpapplication.resolverequestcache.aspx) event).</span></span>

<span data-ttu-id="4c8f1-138">Premere F5 per eseguire l'app. La finestra di output viene illustrato quanto segue:</span><span class="sxs-lookup"><span data-stu-id="4c8f1-138">Hit F5 to run the app.The output window shows the following:</span></span>

[!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample7.cmd)]

## <a name="stage-marker-rules"></a><span data-ttu-id="4c8f1-139">Fase di marcatore</span><span class="sxs-lookup"><span data-stu-id="4c8f1-139">Stage Marker Rules</span></span>

<span data-ttu-id="4c8f1-140">Componenti di middleware Owin (OMC) possono essere configurati per eseguire gli eventi di fase della pipeline OWIN seguenti:</span><span class="sxs-lookup"><span data-stu-id="4c8f1-140">Owin middleware components (OMC) can be configured to run at the following OWIN pipeline stage events:</span></span>

[!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample8.cs)]

1. <span data-ttu-id="4c8f1-141">Per impostazione predefinita, OMCs eseguite in corrispondenza dell'ultimo evento (`PreHandlerExecute`).</span><span class="sxs-lookup"><span data-stu-id="4c8f1-141">By default, OMCs run at the last event (`PreHandlerExecute`).</span></span> <span data-ttu-id="4c8f1-142">Ecco perché il primo codice di esempio visualizzato "PreExecuteRequestHandler".</span><span class="sxs-lookup"><span data-stu-id="4c8f1-142">That's why our first example code displayed "PreExecuteRequestHandler".</span></span>
2. <span data-ttu-id="4c8f1-143">È possibile utilizzare l'un `app.UseStageMarker` metodo per registrare un OMC eseguire versioni precedenti, in qualsiasi fase della pipeline OWIN elencati nel `PipelineStage` enum.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-143">You can use the a `app.UseStageMarker` method to register a OMC to run earlier, at any stage of the OWIN pipeline listed in the `PipelineStage` enum.</span></span>
3. <span data-ttu-id="4c8f1-144">La pipeline OWIN e la pipeline IIS è ordinato, pertanto le chiamate a `app.UseStageMarker` deve essere in ordine.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-144">The OWIN pipeline and the IIS pipeline is ordered, therefore calls to `app.UseStageMarker` must be in order.</span></span> <span data-ttu-id="4c8f1-145">Non è possibile impostare il gestore dell'evento a un evento che precede l'ultimo evento registrato con `app.UseStageMarker`.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-145">You cannot set the event handler to an event that precedes the last event registered with to `app.UseStageMarker`.</span></span> <span data-ttu-id="4c8f1-146">Ad esempio, *dopo* chiamata:</span><span class="sxs-lookup"><span data-stu-id="4c8f1-146">For example, *after* calling:</span></span>

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample9.cmd)]

   <span data-ttu-id="4c8f1-147">le chiamate a `app.UseStageMarker` passando `Authenticate` o `PostAuthenticate` non sarà possibile applicare e non verrà generata alcuna eccezione.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-147">calls to `app.UseStageMarker` passing `Authenticate` or `PostAuthenticate` will not be honored, and no exception will be thrown.</span></span> <span data-ttu-id="4c8f1-148">Eseguire durante la fase più recente, che per impostazione predefinita è OMCs `PreHandlerExecute`.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-148">OMCs run at the latest stage, which by default is `PreHandlerExecute`.</span></span> <span data-ttu-id="4c8f1-149">Affinché vengano eseguiti in precedenza, vengono utilizzati i marcatori di fase.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-149">The stage markers are used to make them to run earlier.</span></span> <span data-ttu-id="4c8f1-150">Se si specificano l'ordine marcatori di fase, si arrotondare al marcatore della precedente.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-150">If you specify stage markers out of order, we round to the earlier marker.</span></span> <span data-ttu-id="4c8f1-151">In altre parole, l'aggiunta di un marcatore di fasi afferma "Esegui entro fase X".</span><span class="sxs-lookup"><span data-stu-id="4c8f1-151">In other words, adding a stage marker says "Run no later than stage X".</span></span> <span data-ttu-id="4c8f1-152">Esecuzione dell'OMC al marcatore di fasi primo aggiunto successivamente nella pipeline OWIN.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-152">OMC's run at the earliest stage marker added after them in the OWIN pipeline.</span></span>
4. <span data-ttu-id="4c8f1-153">La prima fase il numero di chiamate al `app.UseStageMarker` wins.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-153">The earliest stage of calls to `app.UseStageMarker` wins.</span></span> <span data-ttu-id="4c8f1-154">Ad esempio, se si passa l'ordine di `app.UseStageMarker` chiamate dall'esempio precedente:</span><span class="sxs-lookup"><span data-stu-id="4c8f1-154">For example, if you switch the order of `app.UseStageMarker` calls from our previous example:</span></span>

    [!code-csharp[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample10.cs?highlight=13,19)]

   <span data-ttu-id="4c8f1-155">Verrà visualizzata la finestra di output:</span><span class="sxs-lookup"><span data-stu-id="4c8f1-155">The output window will display:</span></span> 

    [!code-console[Main](owin-middleware-in-the-iis-integrated-pipeline/samples/sample11.cmd)]

   <span data-ttu-id="4c8f1-156">Il OMCs eseguiti nel `AuthenticateRequest` fase, perché l'ultima OMC registrato con il `Authenticate` evento e `Authenticate` evento precede tutti gli altri eventi.</span><span class="sxs-lookup"><span data-stu-id="4c8f1-156">The OMCs all run in the `AuthenticateRequest` stage, because the last OMC registered with the `Authenticate` event, and the `Authenticate` event precedes all other events.</span></span>
