---
uid: web-api/overview/security/individual-accounts-in-web-api
title: Proteggere un'API Web con singoli account e un account di accesso locale in ASP.NET Web API 2.2 | Documenti Microsoft
author: MikeWasson
description: In questo argomento viene illustrato come proteggere un'API web usando OAuth2 per l'autenticazione per un database di appartenenza. Versioni del software utilizzate con l'esercitazione 201 Studio Visual...
ms.author: aspnetcontent
manager: wpickett
ms.date: 10/15/2014
ms.topic: article
ms.assetid: 92c84846-f0ea-4b5e-94b6-5004874eb060
ms.technology: dotnet-webapi
ms.prod: .net-framework
msc.legacyurl: /web-api/overview/security/individual-accounts-in-web-api
msc.type: authoredcontent
ms.openlocfilehash: e2056e769edf972cba830b31cf37f6418148ca73
ms.sourcegitcommit: 060879fcf3f73d2366b5c811986f8695fff65db8
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 01/24/2018
ms.locfileid: "28038286"
---
<a name="secure-a-web-api-with-individual-accounts-and-local-login-in-aspnet-web-api-22"></a><span data-ttu-id="3d7ad-104">Proteggere un'API Web con singoli account e un account di accesso locale in ASP.NET Web API 2.2</span><span class="sxs-lookup"><span data-stu-id="3d7ad-104">Secure a Web API with Individual Accounts and Local Login in ASP.NET Web API 2.2</span></span>
====================
<span data-ttu-id="3d7ad-105">da [Mike Wasson](https://github.com/MikeWasson)</span><span class="sxs-lookup"><span data-stu-id="3d7ad-105">by [Mike Wasson](https://github.com/MikeWasson)</span></span>

[<span data-ttu-id="3d7ad-106">Scaricare App di esempio</span><span class="sxs-lookup"><span data-stu-id="3d7ad-106">Download Sample App</span></span>](https://github.com/MikeWasson/LocalAccountsApp)

> <span data-ttu-id="3d7ad-107">In questo argomento viene illustrato come proteggere un'API web usando OAuth2 per l'autenticazione per un database di appartenenza.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-107">This topic shows how to secure a web API using OAuth2 to authenticate against a membership database.</span></span>
> 
> ## <a name="software-versions-used-in-the-tutorial"></a><span data-ttu-id="3d7ad-108">Versioni del software utilizzate nell'esercitazione</span><span class="sxs-lookup"><span data-stu-id="3d7ad-108">Software versions used in the tutorial</span></span>
> 
> 
> - [<span data-ttu-id="3d7ad-109">Visual Studio 2013 Update 3</span><span class="sxs-lookup"><span data-stu-id="3d7ad-109">Visual Studio 2013 Update 3</span></span>](https://www.microsoft.com/visualstudio/eng/2013-downloads)
> - [<span data-ttu-id="3d7ad-110">2.2 API Web</span><span class="sxs-lookup"><span data-stu-id="3d7ad-110">Web API 2.2</span></span>](../releases/whats-new-in-aspnet-web-api-22.md)
> - [<span data-ttu-id="3d7ad-111">ASP.NET Identity 2.1</span><span class="sxs-lookup"><span data-stu-id="3d7ad-111">ASP.NET Identity 2.1</span></span>](../../../identity/index.md)


<span data-ttu-id="3d7ad-112">In Visual Studio 2013, il modello di progetto API Web fornisce tre opzioni per l'autenticazione:</span><span class="sxs-lookup"><span data-stu-id="3d7ad-112">In Visual Studio 2013, the Web API project template gives you three options for authentication:</span></span>

- <span data-ttu-id="3d7ad-113">**Singoli account.**</span><span class="sxs-lookup"><span data-stu-id="3d7ad-113">**Individual accounts.**</span></span> <span data-ttu-id="3d7ad-114">L'app Usa un database di appartenenza.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-114">The app uses a membership database.</span></span>
- <span data-ttu-id="3d7ad-115">**Account aziendali.**</span><span class="sxs-lookup"><span data-stu-id="3d7ad-115">**Organizational accounts.**</span></span> <span data-ttu-id="3d7ad-116">Gli utenti accedono con i relativi Azure Active Directory, Office 365 o credenziali di Active Directory locale.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-116">Users sign in with their Azure Active Directory, Office 365, or on-premise Active Directory credentials.</span></span>
- <span data-ttu-id="3d7ad-117">**Autenticazione di Windows.**</span><span class="sxs-lookup"><span data-stu-id="3d7ad-117">**Windows authentication.**</span></span> <span data-ttu-id="3d7ad-118">Questa opzione è solo per applicazioni Intranet e Usa il modulo IIS di autenticazione di Windows.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-118">This option is intended for Intranet applications, and uses the Windows Authentication IIS module.</span></span>

<span data-ttu-id="3d7ad-119">Per ulteriori informazioni su queste opzioni, vedere [creazione di progetti Web ASP.NET in Visual Studio 2013](../../../visual-studio/overview/2013/creating-web-projects-in-visual-studio.md#auth).</span><span class="sxs-lookup"><span data-stu-id="3d7ad-119">For more details about these options, see [Creating ASP.NET Web Projects in Visual Studio 2013](../../../visual-studio/overview/2013/creating-web-projects-in-visual-studio.md#auth).</span></span>

<span data-ttu-id="3d7ad-120">Singoli account forniscono due modi per un utente di accesso:</span><span class="sxs-lookup"><span data-stu-id="3d7ad-120">Individual accounts provide two ways for a user to log in:</span></span>

- <span data-ttu-id="3d7ad-121">**Account di accesso locale**.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-121">**Local login**.</span></span> <span data-ttu-id="3d7ad-122">L'utente registra nel sito, immettere un nome utente e password.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-122">The user registers at the site, entering a username and password.</span></span> <span data-ttu-id="3d7ad-123">L'app consente di archiviare l'hash della password nel database delle appartenenze.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-123">The app stores the password hash in the membership database.</span></span> <span data-ttu-id="3d7ad-124">Quando l'utente effettua l'accesso, il sistema di identità di ASP.NET viene verificata la password.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-124">When the user logs in, the ASP.NET Identity system verifies the password.</span></span>
- <span data-ttu-id="3d7ad-125">**Account di accesso social**.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-125">**Social login**.</span></span> <span data-ttu-id="3d7ad-126">L'utente accede con un servizio esterno, ad esempio Facebook, Microsoft o Google.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-126">The user signs in with an external service, such as Facebook, Microsoft, or Google.</span></span> <span data-ttu-id="3d7ad-127">Ancora l'app viene creata una voce per l'utente nel database delle appartenenze, ma non archivia le credenziali.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-127">The app still creates an entry for the user in the membership database, but does not store any credentials.</span></span> <span data-ttu-id="3d7ad-128">L'utente viene autenticato mediante l'accesso al servizio esterno.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-128">The user authenticates by signing into the external service.</span></span>

<span data-ttu-id="3d7ad-129">In questo articolo esamina lo scenario di account di accesso locale.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-129">This article looks at the local login scenario.</span></span> <span data-ttu-id="3d7ad-130">Per account di accesso locali e sociali, API Web utilizzi OAuth2 per autenticare le richieste.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-130">For both local and social login, Web API uses OAuth2 to authenticate requests.</span></span> <span data-ttu-id="3d7ad-131">Tuttavia, i flussi di credenziali sono diversi per account di accesso locale e sociale.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-131">However, the credential flows are different for local and social login.</span></span>

<span data-ttu-id="3d7ad-132">In questo articolo viene illustrato una semplice app che consente all'utente di accedere e inviare chiamate AJAX autenticate da un'API web.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-132">In this article, I'll demonstrate a simple app that lets the user log in and send authenticated AJAX calls to a web API.</span></span> <span data-ttu-id="3d7ad-133">È possibile scaricare il codice di esempio [qui](https://github.com/MikeWasson/LocalAccountsApp).</span><span class="sxs-lookup"><span data-stu-id="3d7ad-133">You can download the sample code [here](https://github.com/MikeWasson/LocalAccountsApp).</span></span> <span data-ttu-id="3d7ad-134">Il file Leggimi viene descritto come creare l'esempio da zero in Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-134">The readme describes how to create the sample from scratch in Visual Studio.</span></span>

[![](individual-accounts-in-web-api/_static/image2.png)](individual-accounts-in-web-api/_static/image1.png)

<span data-ttu-id="3d7ad-135">L'app di esempio utilizza Knockout.js per associazione a dati e jQuery per inviare le richieste AJAX.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-135">The sample app uses Knockout.js for data-binding and jQuery for sending AJAX requests.</span></span> <span data-ttu-id="3d7ad-136">Sarà possibile concentrarsi sulle chiamate AJAX, in modo che non è necessario conoscere Knockout.js per questo articolo.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-136">I'll be focusing on the AJAX calls, so you don't need to know Knockout.js for this article.</span></span>

<span data-ttu-id="3d7ad-137">Inoltre, verranno descritti:</span><span class="sxs-lookup"><span data-stu-id="3d7ad-137">Along the way, I'll describe:</span></span>

- <span data-ttu-id="3d7ad-138">L'app operazioni eseguite sul lato client.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-138">What the app is doing on the client side.</span></span>
- <span data-ttu-id="3d7ad-139">Qual è il problema nel server.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-139">What's happening on the server.</span></span>
- <span data-ttu-id="3d7ad-140">Il traffico HTTP al centro.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-140">The HTTP traffic in the middle.</span></span>

<span data-ttu-id="3d7ad-141">In primo luogo, è necessario definire la terminologia OAuth2.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-141">First, we need to define some OAuth2 terminology.</span></span>

- <span data-ttu-id="3d7ad-142">*Risorsa*.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-142">*Resource*.</span></span> <span data-ttu-id="3d7ad-143">Una parte dei dati che possono essere protetti.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-143">Some piece of data that can be protected.</span></span>
- <span data-ttu-id="3d7ad-144">*Server di risorse*.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-144">*Resource server*.</span></span> <span data-ttu-id="3d7ad-145">Il server che ospita la risorsa.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-145">The server that hosts the resource.</span></span>
- <span data-ttu-id="3d7ad-146">*Proprietario della risorsa*.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-146">*Resource owner*.</span></span> <span data-ttu-id="3d7ad-147">L'entità che è possibile concedere l'autorizzazione per accedere a una risorsa.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-147">The entity that can grant permission to access a resource.</span></span> <span data-ttu-id="3d7ad-148">(In genere l'utente.)</span><span class="sxs-lookup"><span data-stu-id="3d7ad-148">(Typically the user.)</span></span>
- <span data-ttu-id="3d7ad-149">*Client*: app che richiede l'accesso alla risorsa.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-149">*Client*: The app that wants access to the resource.</span></span> <span data-ttu-id="3d7ad-150">In questo articolo, il client è un web browser.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-150">In this article, the client is a web browser.</span></span>
- <span data-ttu-id="3d7ad-151">*Token di accesso*.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-151">*Access token*.</span></span> <span data-ttu-id="3d7ad-152">Token che concede l'accesso a una risorsa.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-152">A token that grants access to a resource.</span></span>
- <span data-ttu-id="3d7ad-153">*Token di connessione*.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-153">*Bearer token*.</span></span> <span data-ttu-id="3d7ad-154">Un particolare tipo di token di accesso, con la proprietà che chiunque può utilizzare il token.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-154">A particular type of access token, with the property that anyone can use the token.</span></span> <span data-ttu-id="3d7ad-155">In altre parole, un client non deve necessariamente una chiave di crittografia o un altro segreto per utilizzare un token di connessione.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-155">In other words, a client doesn't need a cryptographic key or other secret to use a bearer token.</span></span> <span data-ttu-id="3d7ad-156">Per questo motivo, i token di connessione devono essere utilizzati solo su un HTTPS e devono avere date di scadenza relativamente breve.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-156">For that reason, bearer tokens should only be used over a HTTPS, and should have relatively short expiration times.</span></span>
- <span data-ttu-id="3d7ad-157">*Server di autorizzazione*.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-157">*Authorization server*.</span></span> <span data-ttu-id="3d7ad-158">Un server che fornisce i token di accesso.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-158">A server that gives out access tokens.</span></span>

<span data-ttu-id="3d7ad-159">Un'applicazione può fungere da server di autorizzazione sia server di risorse.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-159">An application can act as both authorization server and resource server.</span></span> <span data-ttu-id="3d7ad-160">Il modello di progetto API Web segue questo modello.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-160">The Web API project template follows this pattern.</span></span>

## <a name="local-login-credential-flow"></a><span data-ttu-id="3d7ad-161">Flusso delle credenziali di account di accesso locale</span><span class="sxs-lookup"><span data-stu-id="3d7ad-161">Local Login Credential Flow</span></span>

<span data-ttu-id="3d7ad-162">Per l'account di accesso locale, l'API Web utilizza il [flusso di risorse proprietario password](http://oauthlib.readthedocs.org/en/latest/oauth2/grants/password.html) definito in OAuth2.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-162">For local login, Web API uses the [resource owner password flow](http://oauthlib.readthedocs.org/en/latest/oauth2/grants/password.html) defined in OAuth2.</span></span>

1. <span data-ttu-id="3d7ad-163">L'utente immette un nome e una password nel client.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-163">The user enters a name and password into the client.</span></span>
2. <span data-ttu-id="3d7ad-164">Il client invia le credenziali al server di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-164">The client sends these credentials to the authorization server.</span></span>
3. <span data-ttu-id="3d7ad-165">Il server di autorizzazione autentica le credenziali e restituisce un token di accesso.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-165">The authorization server authenticates the credentials and returns an access token.</span></span>
4. <span data-ttu-id="3d7ad-166">Per accedere a una risorsa protetta, il client include il token di accesso nell'intestazione di autorizzazione della richiesta HTTP.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-166">To access a protected resource, the client includes the access token in the Authorization header of the HTTP request.</span></span>

![](individual-accounts-in-web-api/_static/image3.png)

<span data-ttu-id="3d7ad-167">Quando si seleziona **singoli account** nel modello di progetto API Web, il progetto include un server di autorizzazione che convalida le credenziali utente e rilascia i token.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-167">When you select **Individual accounts** in the Web API project template, the project includes an authorization server that validates user credentials and issues tokens.</span></span> <span data-ttu-id="3d7ad-168">Il diagramma seguente mostra lo stesso flusso di credenziali in termini di componenti dell'API Web.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-168">The following diagram shows the same credential flow in terms of Web API components.</span></span>

![](individual-accounts-in-web-api/_static/image4.png)

<span data-ttu-id="3d7ad-169">In questo scenario, controller API Web fungono da server di risorse.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-169">In this scenario, Web API controllers act as resource servers.</span></span> <span data-ttu-id="3d7ad-170">Un filtro di autenticazione convalida i token di accesso e **[Authorize]** attributo viene utilizzato per proteggere una risorsa.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-170">An authentication filter validates access tokens, and the **[Authorize]** attribute is used to protect a resource.</span></span> <span data-ttu-id="3d7ad-171">Quando un controller o un'azione ha il **[Authorize]** attributo, tutte le richieste in tale controller o l'azione deve essere autenticata.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-171">When a controller or action has the **[Authorize]** attribute, all requests to that controller or action must be authenticated.</span></span> <span data-ttu-id="3d7ad-172">In caso contrario, l'autorizzazione viene negata e l'API Web restituisce un errore 401 (non autorizzato).</span><span class="sxs-lookup"><span data-stu-id="3d7ad-172">Otherwise, authorization is denied, and Web API returns a 401 (Unauthorized) error.</span></span>

<span data-ttu-id="3d7ad-173">Il server di autorizzazione e il filtro di autenticazione sia chiamerà un [middleware OWIN](../../../aspnet/overview/owin-and-katana/an-overview-of-project-katana.md) componente che gestisce i dettagli di OAuth2.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-173">The authorization server and the authentication filter both call into an [OWIN middleware](../../../aspnet/overview/owin-and-katana/an-overview-of-project-katana.md) component that handles the details of OAuth2.</span></span> <span data-ttu-id="3d7ad-174">Verrà descritta la progettazione in modo più dettagliato più avanti in questa esercitazione.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-174">I'll describe the design in more detail later in this tutorial.</span></span>

## <a name="sending-an-unauthorized-request"></a><span data-ttu-id="3d7ad-175">L'invio di una richiesta non autorizzata</span><span class="sxs-lookup"><span data-stu-id="3d7ad-175">Sending an Unauthorized Request</span></span>

<span data-ttu-id="3d7ad-176">Per iniziare, eseguire l'app e fare clic su di **chiamare API** pulsante.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-176">To get started, run the app and click the **Call API** button.</span></span> <span data-ttu-id="3d7ad-177">Al completamento della richiesta, si dovrebbe vedere un messaggio di errore nel **risultato** casella.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-177">When the request completes, you should see an error message in the **Result** box.</span></span> <span data-ttu-id="3d7ad-178">Ciò avviene perché la richiesta non contiene un token di accesso, la richiesta non è autorizzata.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-178">That's because the request does not contain an access token, so the request is unauthorized.</span></span>

[![](individual-accounts-in-web-api/_static/image6.png)](individual-accounts-in-web-api/_static/image5.png)

<span data-ttu-id="3d7ad-179">Il **chiamare API** pulsante Invia una richiesta AJAX ~/api/valori, che richiama un'azione del controller API Web.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-179">The **Call API** button sends an AJAX request to ~/api/values, which invokes a Web API controller action.</span></span> <span data-ttu-id="3d7ad-180">Di seguito è riportata la sezione di codice JavaScript che invia la richiesta AJAX.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-180">Here is the section of JavaScript code that sends the AJAX request.</span></span> <span data-ttu-id="3d7ad-181">Nell'applicazione di esempio, tutto il codice di app JavaScript si trova nel file Scripts\app.js.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-181">In the sample app, all of the JavaScript app code is located in the Scripts\app.js file.</span></span>

[!code-javascript[Main](individual-accounts-in-web-api/samples/sample1.js)]

<span data-ttu-id="3d7ad-182">Fino a quando l'utente si connette, non vi è alcun token di connessione e pertanto alcuna intestazione di autorizzazione nella richiesta.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-182">Until the user logs in, there is no bearer token, and therefore no Authorization header in the request.</span></span> <span data-ttu-id="3d7ad-183">In questo modo la richiesta restituire un errore 401.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-183">This causes the request to return a 401 error.</span></span>

<span data-ttu-id="3d7ad-184">Di seguito è riportata la richiesta HTTP.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-184">Here is the HTTP request.</span></span> <span data-ttu-id="3d7ad-185">(Utilizzato [Fiddler](http://www.telerik.com/fiddler) per acquisire il traffico HTTP.)</span><span class="sxs-lookup"><span data-stu-id="3d7ad-185">(I used [Fiddler](http://www.telerik.com/fiddler) to capture the HTTP traffic.)</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample2.cmd)]

<span data-ttu-id="3d7ad-186">Risposta HTTP:</span><span class="sxs-lookup"><span data-stu-id="3d7ad-186">HTTP response:</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample3.cmd?highlight=1,4)]

<span data-ttu-id="3d7ad-187">Si noti che la risposta include un'intestazione Www-Authenticate con la richiesta di verifica impostato su una connessione.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-187">Notice that the response includes a Www-Authenticate header with the challenge set to Bearer.</span></span> <span data-ttu-id="3d7ad-188">Che indica che il server è previsto un token di connessione.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-188">That indicates the server expects a bearer token.</span></span>

## <a name="register-a-user"></a><span data-ttu-id="3d7ad-189">Registrazione di un utente</span><span class="sxs-lookup"><span data-stu-id="3d7ad-189">Register a User</span></span>

<span data-ttu-id="3d7ad-190">Nel **registrare** sezione dell'app, immettere un messaggio di posta elettronica e una password, quindi scegliere il **registrare** pulsante.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-190">In the **Register** section of the app, enter an email and password, and click the **Register** button.</span></span>

<span data-ttu-id="3d7ad-191">Non è necessario utilizzare un indirizzo di posta elettronica valido per questo esempio, ma un'applicazione reale si conferma l'indirizzo.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-191">You don't need to use a valid email address for this sample, but a real app would confirm the address.</span></span> <span data-ttu-id="3d7ad-192">(Vedere [creare un'app web di ASP.NET MVC 5 sicura con l'accesso, la reimpostazione di posta elettronica di conferma e la password](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).) Per la password, utilizzare simile al seguente "Password1!", con una lettera maiuscola, lettere minuscole, numero e i caratteri non alfanumerici.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-192">(See [Create a secure ASP.NET MVC 5 web app with log in, email confirmation and password reset](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).) For the password, use something like "Password1!", with an upper case letter, lower case letter, number, and non-alpha-numeric character.</span></span> <span data-ttu-id="3d7ad-193">Per semplificare l'app, tralasciato convalida lato client, pertanto se si verifica un problema con il formato della password, si otterrà un errore 400 (richiesta non valida).</span><span class="sxs-lookup"><span data-stu-id="3d7ad-193">To keep the app simple, I left out client-side validation, so if there is a problem with the password format, you'll get a 400 (Bad Request) error.</span></span>

[![](individual-accounts-in-web-api/_static/image8.png)](individual-accounts-in-web-api/_static/image7.png)

<span data-ttu-id="3d7ad-194">Il **registrare** pulsante Invia una richiesta POST per ~/api/Account/Register /.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-194">The **Register** button sends a POST request to ~/api/Account/Register/.</span></span> <span data-ttu-id="3d7ad-195">Il corpo della richiesta è un oggetto JSON che contiene il nome e la password.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-195">The request body is a JSON object that holds the name and password.</span></span> <span data-ttu-id="3d7ad-196">Ecco il codice JavaScript che invia la richiesta:</span><span class="sxs-lookup"><span data-stu-id="3d7ad-196">Here is the JavaScript code that sends the request:</span></span>

[!code-javascript[Main](individual-accounts-in-web-api/samples/sample4.js)]

<span data-ttu-id="3d7ad-197">Richiesta HTTP:</span><span class="sxs-lookup"><span data-stu-id="3d7ad-197">HTTP request:</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample5.cmd?highlight=5,10)]

<span data-ttu-id="3d7ad-198">Risposta HTTP:</span><span class="sxs-lookup"><span data-stu-id="3d7ad-198">HTTP response:</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample6.cmd)]

<span data-ttu-id="3d7ad-199">Questa richiesta viene gestita dalla `AccountController` classe.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-199">This request is handled by the `AccountController` class.</span></span> <span data-ttu-id="3d7ad-200">Internamente, `AccountController` Usa identità ASP.NET per gestire il database delle appartenenze.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-200">Internally, `AccountController` uses ASP.NET Identity to manage the membership database.</span></span>

<span data-ttu-id="3d7ad-201">Se si esegue l'app localmente da Visual Studio, gli account utente vengono archiviati nel database locale nella tabella AspNetUsers.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-201">If you run the app locally from Visual Studio, user accounts are stored in LocalDB, in the AspNetUsers table.</span></span> <span data-ttu-id="3d7ad-202">Per visualizzare le tabelle in Visual Studio, scegliere il **vista** dal menu **Esplora Server**, quindi espandere **connessioni dati**.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-202">To view the tables in Visual Studio, click the **View** menu, select **Server Explorer**, then expand **Data Connections**.</span></span>

![](individual-accounts-in-web-api/_static/image9.png)

## <a name="get-an-access-token"></a><span data-ttu-id="3d7ad-203">Ottenere un accesso Token</span><span class="sxs-lookup"><span data-stu-id="3d7ad-203">Get an Access Token</span></span>

<span data-ttu-id="3d7ad-204">Finora che abbiamo realizzato non qualsiasi OAuth, ma il server di autorizzazione OAuth in azione, ora è visualizzato quando si richiede un token di accesso.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-204">So far we have not done any OAuth, but now we'll see the OAuth authorization server in action, when we request an access token.</span></span> <span data-ttu-id="3d7ad-205">Nel **Accedi** area dell'applicazione di esempio, immettere il messaggio di posta elettronica e la password e fare clic su **Accedi**.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-205">In the **Log In** area of the sample app, enter the email and password and click **Log In**.</span></span>

[![](individual-accounts-in-web-api/_static/image11.png)](individual-accounts-in-web-api/_static/image10.png)

<span data-ttu-id="3d7ad-206">Il **Accedi** pulsante Invia una richiesta all'endpoint token.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-206">The **Log In** button sends a request to the token endpoint.</span></span> <span data-ttu-id="3d7ad-207">Il corpo della richiesta contiene i dati codificati negli url di form seguenti:</span><span class="sxs-lookup"><span data-stu-id="3d7ad-207">The body of the request contains the following form-url-encoded data:</span></span>

- <span data-ttu-id="3d7ad-208">concedere\_tipo: "password"</span><span class="sxs-lookup"><span data-stu-id="3d7ad-208">grant\_type: "password"</span></span>
- <span data-ttu-id="3d7ad-209">nome utente: &lt;posta elettronica dell'utente&gt;</span><span class="sxs-lookup"><span data-stu-id="3d7ad-209">username: &lt;the user's email&gt;</span></span>
- <span data-ttu-id="3d7ad-210">password: &lt;password&gt;</span><span class="sxs-lookup"><span data-stu-id="3d7ad-210">password: &lt;password&gt;</span></span>

<span data-ttu-id="3d7ad-211">Ecco il codice JavaScript che invia la richiesta AJAX:</span><span class="sxs-lookup"><span data-stu-id="3d7ad-211">Here is the JavaScript code that sends the AJAX request:</span></span>

[!code-javascript[Main](individual-accounts-in-web-api/samples/sample7.js?highlight=14)]

<span data-ttu-id="3d7ad-212">Se la richiesta ha esito positivo, il server di autorizzazione restituisce un token di accesso nel corpo della risposta.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-212">If the request succeeds, the authorization server returns an access token in the response body.</span></span> <span data-ttu-id="3d7ad-213">Si noti che, il token viene memorizzato in archiviazione di sessione, da utilizzare in un secondo momento durante l'invio di richieste all'API.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-213">Notice that we store the token in session storage, to use later when sending requests to the API.</span></span> <span data-ttu-id="3d7ad-214">A differenza di alcuni moduli di autenticazione (ad esempio l'autenticazione basata su cookie), il browser non includerà automaticamente il token di accesso nelle richieste successive.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-214">Unlike some forms of authentication (such as cookie-based authentication), the browser will not automatically include the access token in subsequent requests.</span></span> <span data-ttu-id="3d7ad-215">L'applicazione deve essere eseguita in modo esplicito.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-215">The application must do so explicitly.</span></span> <span data-ttu-id="3d7ad-216">Che è utile poiché limita [vulnerabilità CSRF](preventing-cross-site-request-forgery-csrf-attacks.md).</span><span class="sxs-lookup"><span data-stu-id="3d7ad-216">That's a good thing, because it limits [CSRF vulnerabilities](preventing-cross-site-request-forgery-csrf-attacks.md).</span></span>

<span data-ttu-id="3d7ad-217">Richiesta HTTP:</span><span class="sxs-lookup"><span data-stu-id="3d7ad-217">HTTP request:</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample8.cmd?highlight=5,10)]

<span data-ttu-id="3d7ad-218">È possibile vedere che la richiesta contiene le credenziali dell'utente.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-218">You can see that the request contains the user's credentials.</span></span> <span data-ttu-id="3d7ad-219">Si *deve* utilizzare HTTPS per garantire la sicurezza di livello di trasporto.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-219">You *must* use HTTPS to provide transport layer security.</span></span>

<span data-ttu-id="3d7ad-220">Risposta HTTP:</span><span class="sxs-lookup"><span data-stu-id="3d7ad-220">HTTP response:</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample9.cmd?highlight=8)]

<span data-ttu-id="3d7ad-221">Per migliorare la leggibilità, è rientrato JSON e troncato il token di accesso, è piuttosto lungo.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-221">For readability, I indented the JSON and truncated the access token, which is a quite long.</span></span>

<span data-ttu-id="3d7ad-222">Il `access_token`, `token_type`, e `expires_in` le proprietà sono definite nella specifica OAuth2. Le altre proprietà (`userName`, `.issued`, e `.expires`) sono solo a scopo informativo.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-222">The `access_token`, `token_type`, and `expires_in` properties are defined by the OAuth2 spec. The other properties (`userName`, `.issued`, and `.expires`) are just for informational purposes.</span></span> <span data-ttu-id="3d7ad-223">È possibile trovare il codice che aggiunge proprietà aggiuntive di `TokenEndpoint` (metodo), nel file /Providers/ApplicationOAuthProvider.cs.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-223">You can find the code that adds those additional properties in the `TokenEndpoint` method, in the /Providers/ApplicationOAuthProvider.cs file.</span></span>

## <a name="send-an-authenticated-request"></a><span data-ttu-id="3d7ad-224">Inviare una richiesta autenticata</span><span class="sxs-lookup"><span data-stu-id="3d7ad-224">Send an Authenticated Request</span></span>

<span data-ttu-id="3d7ad-225">Ora che è disponibile un token di connessione, è possibile rendere una richiesta autenticata all'API.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-225">Now that we have a bearer token, we can make an authenticated request to the API.</span></span> <span data-ttu-id="3d7ad-226">Questa operazione viene eseguita impostando l'intestazione di autorizzazione nella richiesta.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-226">This is done by setting the Authorization header in the request.</span></span> <span data-ttu-id="3d7ad-227">Fare clic su di **chiamare API** pulsante nuovo per visualizzare il risultato.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-227">Click the **Call API** button again to see this.</span></span>

[![](individual-accounts-in-web-api/_static/image13.png)](individual-accounts-in-web-api/_static/image12.png)

<span data-ttu-id="3d7ad-228">Richiesta HTTP:</span><span class="sxs-lookup"><span data-stu-id="3d7ad-228">HTTP request:</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample10.cmd?highlight=5)]

<span data-ttu-id="3d7ad-229">Risposta HTTP:</span><span class="sxs-lookup"><span data-stu-id="3d7ad-229">HTTP response:</span></span>

[!code-console[Main](individual-accounts-in-web-api/samples/sample11.cmd)]

## <a name="log-out"></a><span data-ttu-id="3d7ad-230">Effettuare la disconnessione</span><span class="sxs-lookup"><span data-stu-id="3d7ad-230">Log Out</span></span>

<span data-ttu-id="3d7ad-231">Poiché il browser non memorizza nella cache le credenziali o il token di accesso, la disconnessione è semplicemente una "dimenticare" il token, rimuovendolo dall'archivio di sessione:</span><span class="sxs-lookup"><span data-stu-id="3d7ad-231">Because the browser does not cache the credentials or the access token, logging out is simply a matter of "forgetting" the token, by removing it from session storage:</span></span>

[!code-javascript[Main](individual-accounts-in-web-api/samples/sample12.js)]

## <a name="understanding-the-individual-accounts-project-template"></a><span data-ttu-id="3d7ad-232">Comprendere il modello di progetto di singoli account</span><span class="sxs-lookup"><span data-stu-id="3d7ad-232">Understanding the Individual Accounts Project Template</span></span>

<span data-ttu-id="3d7ad-233">Quando si seleziona **singoli account** nel modello di progetto applicazione Web ASP.NET, il progetto include:</span><span class="sxs-lookup"><span data-stu-id="3d7ad-233">When you select **Individual Accounts** in the ASP.NET Web Application project template, the project includes:</span></span>

- <span data-ttu-id="3d7ad-234">Un server di autorizzazione OAuth2.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-234">An OAuth2 authorization server.</span></span>
- <span data-ttu-id="3d7ad-235">Un endpoint Web API per la gestione degli account utente</span><span class="sxs-lookup"><span data-stu-id="3d7ad-235">A Web API endpoint for managing user accounts</span></span>
- <span data-ttu-id="3d7ad-236">Un modello di Entity Framework per l'archiviazione di account utente.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-236">An EF model for storing user accounts.</span></span>

<span data-ttu-id="3d7ad-237">Di seguito sono le classi dell'applicazione principale che implementano queste funzionalità:</span><span class="sxs-lookup"><span data-stu-id="3d7ad-237">Here are the main application classes that implement these features:</span></span>

- <span data-ttu-id="3d7ad-238">`AccountController`.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-238">`AccountController`.</span></span> <span data-ttu-id="3d7ad-239">Fornisce un endpoint Web API per la gestione degli account utente.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-239">Provides a Web API endpoint for managing user accounts.</span></span> <span data-ttu-id="3d7ad-240">Il `Register` azione è l'unica che è stato usato in questa esercitazione.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-240">The `Register` action is the only one that we used in this tutorial.</span></span> <span data-ttu-id="3d7ad-241">Altri metodi sulla classe supportano la reimpostazione della password, gli account di accesso social networking e altre funzionalità.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-241">Other methods on the class support password reset, social logins, and other functionality.</span></span>
- <span data-ttu-id="3d7ad-242">`ApplicationUser`, definito in /Models/IdentityModels.cs.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-242">`ApplicationUser`, defined in /Models/IdentityModels.cs.</span></span> <span data-ttu-id="3d7ad-243">Questa classe è il modello di Entity Framework per gli account utente nel database delle appartenenze.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-243">This class is the EF model for user accounts in the membership database.</span></span>
- <span data-ttu-id="3d7ad-244">`ApplicationUserManager`, definito in /App\_Start/IdentityConfig.cs tale classe deriva dalla [UserManager](https://msdn.microsoft.com/library/dn613290.aspx) e vengono eseguite operazioni sugli account utente, ad esempio la creazione di un nuovo utente, la verifica delle password e così via e rende automaticamente persistente modifiche al database.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-244">`ApplicationUserManager`, defined in /App\_Start/IdentityConfig.cs This class derives from [UserManager](https://msdn.microsoft.com/library/dn613290.aspx) and performs operations on user accounts, such as creating a new user, verifying passwords, and so forth, and automatically persists changes to the database.</span></span>
- <span data-ttu-id="3d7ad-245">`ApplicationOAuthProvider`.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-245">`ApplicationOAuthProvider`.</span></span> <span data-ttu-id="3d7ad-246">L'oggetto si collega il middleware OWIN ed elabora gli eventi generati dal middleware.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-246">This object plugs into the OWIN middleware, and processes events raised by the middleware.</span></span> <span data-ttu-id="3d7ad-247">Deriva da [OAuthAuthorizationServerProvider](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserverprovider.aspx).</span><span class="sxs-lookup"><span data-stu-id="3d7ad-247">It derives from [OAuthAuthorizationServerProvider](https://msdn.microsoft.com/library/microsoft.owin.security.oauth.oauthauthorizationserverprovider.aspx).</span></span>

![](individual-accounts-in-web-api/_static/image14.png)

### <a name="configuring-the-authorization-server"></a><span data-ttu-id="3d7ad-248">Configurazione del Server di autorizzazione</span><span class="sxs-lookup"><span data-stu-id="3d7ad-248">Configuring the Authorization Server</span></span>

<span data-ttu-id="3d7ad-249">In StartupAuth.cs, il codice seguente consente di configurare il server di autorizzazione OAuth2.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-249">In StartupAuth.cs, the following code configures the OAuth2 authorization server.</span></span>

[!code-csharp[Main](individual-accounts-in-web-api/samples/sample13.cs)]

<span data-ttu-id="3d7ad-250">Il `TokenEndpointPath` proprietà è il percorso URL endpoint del server di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-250">The `TokenEndpointPath` property is the URL path to the authorization server endpoint.</span></span> <span data-ttu-id="3d7ad-251">Che rappresenta l'URL viene utilizzato tale app per ottenere il token di connessione.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-251">That's the URL that app uses to get the bearer tokens.</span></span>

<span data-ttu-id="3d7ad-252">Il `Provider` proprietà specifica un provider che si collega il middleware OWIN ed elabora gli eventi generati dal middleware.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-252">The `Provider` property specifies a provider that plugs into the OWIN middleware, and processes events raised by the middleware.</span></span>

<span data-ttu-id="3d7ad-253">Ecco il flusso di base quando si desidera ottenere un token all'app:</span><span class="sxs-lookup"><span data-stu-id="3d7ad-253">Here is the basic flow when the app wants to get a token:</span></span>

1. <span data-ttu-id="3d7ad-254">Per ottenere un token di accesso, l'app invia una richiesta di ~ / Token.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-254">To get an access token, the app sends a request to ~/Token.</span></span>
2. <span data-ttu-id="3d7ad-255">Le chiamate di middleware OAuth `GrantResourceOwnerCredentials` nel provider.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-255">The OAuth middleware calls `GrantResourceOwnerCredentials` on the provider.</span></span>
3. <span data-ttu-id="3d7ad-256">Il provider chiama il `ApplicationUserManager` per convalidare le credenziali e creare un'identità basata sulle attestazioni.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-256">The provider calls the `ApplicationUserManager` to validate the credentials and create a claims identity.</span></span>
4. <span data-ttu-id="3d7ad-257">Se l'operazione riesce, il provider crea un ticket di autenticazione, viene utilizzato per generare il token.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-257">If that succeeds, the provider creates an authentication ticket, which is used to generate the token.</span></span>

[![](individual-accounts-in-web-api/_static/image16.png)](individual-accounts-in-web-api/_static/image15.png)

<span data-ttu-id="3d7ad-258">Il middleware di OAuth non conosce gli account utente.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-258">The OAuth middleware doesn't know anything about the user accounts.</span></span> <span data-ttu-id="3d7ad-259">Il provider gestisce la comunicazione tra il middleware e l'identità di ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-259">The provider communicates between the middleware and ASP.NET Identity.</span></span> <span data-ttu-id="3d7ad-260">Per ulteriori informazioni sull'implementazione di server di autorizzazione, vedere [OWIN OAuth 2.0 autorizzazione Server](../../../aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server.md).</span><span class="sxs-lookup"><span data-stu-id="3d7ad-260">For more information about implementing the authorization server, see [OWIN OAuth 2.0 Authorization Server](../../../aspnet/overview/owin-and-katana/owin-oauth-20-authorization-server.md).</span></span>

### <a name="configuring-web-api-to-use-bearer-tokens"></a><span data-ttu-id="3d7ad-261">Configurazione Web API, utilizzare i token di connessione</span><span class="sxs-lookup"><span data-stu-id="3d7ad-261">Configuring Web API to use Bearer Tokens</span></span>

<span data-ttu-id="3d7ad-262">Nel `WebApiConfig.Register` metodo, il codice seguente imposta l'autenticazione per la pipeline di Web API:</span><span class="sxs-lookup"><span data-stu-id="3d7ad-262">In the `WebApiConfig.Register` method, the following code sets up authentication for the Web API pipeline:</span></span>

[!code-csharp[Main](individual-accounts-in-web-api/samples/sample14.cs)]

<span data-ttu-id="3d7ad-263">Il **HostAuthenticationFilter** classe consente l'autenticazione tramite i token di connessione.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-263">The **HostAuthenticationFilter** class enables authentication using bearer tokens.</span></span>

<span data-ttu-id="3d7ad-264">Il **SuppressDefaultHostAuthentication** metodo indica l'API Web per ignorare qualsiasi autenticazione che si verifica prima che la richiesta raggiunga la pipeline di Web API, da IIS o dal middleware OWIN.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-264">The **SuppressDefaultHostAuthentication** method tells Web API to ignore any authentication that happens before the request reaches the Web API pipeline, either by IIS or by OWIN middleware.</span></span> <span data-ttu-id="3d7ad-265">In questo modo, è possibile limitare l'API Web per l'autenticazione solo tramite i token di connessione.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-265">That way, we can restrict Web API to authenticate only using bearer tokens.</span></span>

> [!NOTE]
> <span data-ttu-id="3d7ad-266">In particolare, la parte MVC dell'app può utilizzare autenticazione basata su form, che archivia le credenziali in un cookie.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-266">In particular, the MVC portion of your app might use forms authentication, which stores credentials in a cookie.</span></span> <span data-ttu-id="3d7ad-267">L'autenticazione basata su cookie richiede l'utilizzo di token antifalsificazione, per impedire attacchi CSRF.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-267">Cookie-based authentication requires the use of anti-forgery tokens, to prevent CSRF attacks.</span></span> <span data-ttu-id="3d7ad-268">Questo è un problema per il web API, poiché non esiste alcun modo pratico per l'API web per inviare il token antifalsificazione al client.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-268">That's a problem for web APIs, because there is no convenient way for the web API to send the anti-forgery token to the client.</span></span> <span data-ttu-id="3d7ad-269">(Per ulteriori informazioni su questo problema, vedere [prevenzione degli attacchi CSRF nell'API Web](preventing-cross-site-request-forgery-csrf-attacks.md).) La chiamata **SuppressDefaultHostAuthentication** garantisce che l'API Web non è vulnerabile ad attacchi CSRF da credenziali archiviate nei cookie.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-269">(For more background on this issue, see [Preventing CSRF Attacks in Web API](preventing-cross-site-request-forgery-csrf-attacks.md).) Calling **SuppressDefaultHostAuthentication** ensures that Web API is not vulnerable to CSRF attacks from credentials stored in cookies.</span></span>


<span data-ttu-id="3d7ad-270">Quando il client richiede una risorsa protetta, ecco cosa accade nella pipeline di Web API:</span><span class="sxs-lookup"><span data-stu-id="3d7ad-270">When the client requests a protected resource, here is what happens in the Web API pipeline:</span></span>

1. <span data-ttu-id="3d7ad-271">Il **HostAuthentication** filtro chiama il middleware di OAuth per convalidare il token.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-271">The **HostAuthentication** filter calls the OAuth middleware to validate the token.</span></span>
2. <span data-ttu-id="3d7ad-272">Il middleware converte il token in un'identità basata sulle attestazioni.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-272">The middleware converts the token into a claims identity.</span></span>
3. <span data-ttu-id="3d7ad-273">A questo punto, la richiesta è *autenticato* ma non *autorizzato*.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-273">At this point, the request is *authenticated* but not *authorized*.</span></span>
4. <span data-ttu-id="3d7ad-274">Il filtro di autorizzazione esamina l'identità basata sulle attestazioni.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-274">The authorization filter examines the claims identity.</span></span> <span data-ttu-id="3d7ad-275">Se le attestazioni di autorizzano dell'utente per tale risorsa, la richiesta è autorizzata.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-275">If the claims authorize the user for that resource, the request is authorized.</span></span> <span data-ttu-id="3d7ad-276">Per impostazione predefinita, il **[Authorize]** attributo autorizzare qualsiasi richiesta che viene autenticato.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-276">By default, the **[Authorize]** attribute will authorize any request that is authenticated.</span></span> <span data-ttu-id="3d7ad-277">Tuttavia, è possibile autorizzare dal ruolo o da altre richieste.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-277">However, you can authorize by role or by other claims.</span></span> <span data-ttu-id="3d7ad-278">Per ulteriori informazioni, vedere [autenticazione e autorizzazione in Web API](authentication-and-authorization-in-aspnet-web-api.md).</span><span class="sxs-lookup"><span data-stu-id="3d7ad-278">For more information, see [Authentication and Authorization in Web API](authentication-and-authorization-in-aspnet-web-api.md).</span></span>
5. <span data-ttu-id="3d7ad-279">Se i passaggi precedenti hanno esito positivo, il controller restituisce alla risorsa protetta.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-279">If the previous steps are successful, the controller returns the protected resource.</span></span> <span data-ttu-id="3d7ad-280">In caso contrario, il client riceve un errore 401 (non autorizzato).</span><span class="sxs-lookup"><span data-stu-id="3d7ad-280">Otherwise, the client receives a 401 (Unauthorized) error.</span></span>

[![](individual-accounts-in-web-api/_static/image18.png)](individual-accounts-in-web-api/_static/image17.png)

## <a name="additional-resources"></a><span data-ttu-id="3d7ad-281">Risorse aggiuntive</span><span class="sxs-lookup"><span data-stu-id="3d7ad-281">Additional Resources</span></span>

- [<span data-ttu-id="3d7ad-282">Identità di ASP.NET</span><span class="sxs-lookup"><span data-stu-id="3d7ad-282">ASP.NET Identity</span></span>](../../../identity/index.md)
- <span data-ttu-id="3d7ad-283">[Informazioni sulle funzionalità di sicurezza nel modello di SPA per VS2013 RC](https://blogs.msdn.com/b/webdev/archive/2013/09/20/understanding-security-features-in-spa-template.aspx).</span><span class="sxs-lookup"><span data-stu-id="3d7ad-283">[Understanding Security Features in the SPA Template for VS2013 RC](https://blogs.msdn.com/b/webdev/archive/2013/09/20/understanding-security-features-in-spa-template.aspx).</span></span> <span data-ttu-id="3d7ad-284">Post di blog MSDN da Hongye Sun.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-284">MSDN blog post by Hongye Sun.</span></span>
- <span data-ttu-id="3d7ad-285">[Sezionando Web API singoli account modello-parte 2: gli account locali](http://leastprivilege.com/2013/11/26/dissecting-the-web-api-individual-accounts-templatepart-2-local-accounts/).</span><span class="sxs-lookup"><span data-stu-id="3d7ad-285">[Dissecting the Web API Individual Accounts Template–Part 2: Local Accounts](http://leastprivilege.com/2013/11/26/dissecting-the-web-api-individual-accounts-templatepart-2-local-accounts/).</span></span> <span data-ttu-id="3d7ad-286">Post di blog di Dominick Baier.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-286">Blog post by Dominick Baier.</span></span>
- <span data-ttu-id="3d7ad-287">[Host di autenticazione e l'API Web con OWIN](http://brockallen.com/2013/10/27/host-authentication-and-web-api-with-owin-and-active-vs-passive-authentication-middleware/).</span><span class="sxs-lookup"><span data-stu-id="3d7ad-287">[Host authentication and Web API with OWIN](http://brockallen.com/2013/10/27/host-authentication-and-web-api-with-owin-and-active-vs-passive-authentication-middleware/).</span></span> <span data-ttu-id="3d7ad-288">Una spiegazione chiara della `SuppressDefaultHostAuthentication` e `HostAuthenticationFilter` da Brock Allen.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-288">A good explanation of `SuppressDefaultHostAuthentication` and `HostAuthenticationFilter` by Brock Allen.</span></span>
- <span data-ttu-id="3d7ad-289">[Personalizzazione delle informazioni del profilo in ASP.NET Identity nei modelli di Visual Studio 2013](https://blogs.msdn.com/b/webdev/archive/2013/10/16/customizing-profile-information-in-asp-net-identity-in-vs-2013-templates.aspx).</span><span class="sxs-lookup"><span data-stu-id="3d7ad-289">[Customizing profile information in ASP.NET Identity in VS 2013 templates](https://blogs.msdn.com/b/webdev/archive/2013/10/16/customizing-profile-information-in-asp-net-identity-in-vs-2013-templates.aspx).</span></span> <span data-ttu-id="3d7ad-290">Post di blog MSDN Pranav Rastogi.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-290">MSDN blog post by Pranav Rastogi.</span></span>
- <span data-ttu-id="3d7ad-291">[Per la gestione della durata richiesta per la classe UserManager in ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span><span class="sxs-lookup"><span data-stu-id="3d7ad-291">[Per request lifetime management for UserManager class in ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span></span> <span data-ttu-id="3d7ad-292">Post di blog MSDN di Suhas Joshi, con una spiegazione chiara della `UserManager` classe.</span><span class="sxs-lookup"><span data-stu-id="3d7ad-292">MSDN blog post by Suhas Joshi, with a good explanation of the `UserManager` class.</span></span>
